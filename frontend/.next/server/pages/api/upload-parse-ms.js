"use strict";
/*
 * ATTENTION: An "eval-source-map" devtool has been used.
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file with attached SourceMaps in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
(() => {
var exports = {};
exports.id = "pages/api/upload-parse-ms";
exports.ids = ["pages/api/upload-parse-ms"];
exports.modules = {

/***/ "next/dist/compiled/next-server/pages-api.runtime.dev.js":
/*!**************************************************************************!*\
  !*** external "next/dist/compiled/next-server/pages-api.runtime.dev.js" ***!
  \**************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/compiled/next-server/pages-api.runtime.dev.js");

/***/ }),

/***/ "node-tesseract-ocr":
/*!*************************************!*\
  !*** external "node-tesseract-ocr" ***!
  \*************************************/
/***/ ((module) => {

module.exports = require("node-tesseract-ocr");

/***/ }),

/***/ "formidable":
/*!*****************************!*\
  !*** external "formidable" ***!
  \*****************************/
/***/ ((module) => {

module.exports = import("formidable");;

/***/ }),

/***/ "child_process":
/*!********************************!*\
  !*** external "child_process" ***!
  \********************************/
/***/ ((module) => {

module.exports = require("child_process");

/***/ }),

/***/ "crypto":
/*!*************************!*\
  !*** external "crypto" ***!
  \*************************/
/***/ ((module) => {

module.exports = require("crypto");

/***/ }),

/***/ "fs":
/*!*********************!*\
  !*** external "fs" ***!
  \*********************/
/***/ ((module) => {

module.exports = require("fs");

/***/ }),

/***/ "path":
/*!***********************!*\
  !*** external "path" ***!
  \***********************/
/***/ ((module) => {

module.exports = require("path");

/***/ }),

/***/ "(api)/./node_modules/next/dist/build/webpack/loaders/next-route-loader/index.js?kind=PAGES_API&page=%2Fapi%2Fupload-parse-ms&preferredRegion=&absolutePagePath=.%2Fsrc%2Fpages%2Fapi%2Fupload-parse-ms.ts&middlewareConfigBase64=e30%3D!":
/*!******************************************************************************************************************************************************************************************************************************************!*\
  !*** ./node_modules/next/dist/build/webpack/loaders/next-route-loader/index.js?kind=PAGES_API&page=%2Fapi%2Fupload-parse-ms&preferredRegion=&absolutePagePath=.%2Fsrc%2Fpages%2Fapi%2Fupload-parse-ms.ts&middlewareConfigBase64=e30%3D! ***!
  \******************************************************************************************************************************************************************************************************************************************/
/***/ ((module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.a(module, async (__webpack_handle_async_dependencies__, __webpack_async_result__) => { try {\n__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   config: () => (/* binding */ config),\n/* harmony export */   \"default\": () => (__WEBPACK_DEFAULT_EXPORT__),\n/* harmony export */   routeModule: () => (/* binding */ routeModule)\n/* harmony export */ });\n/* harmony import */ var next_dist_server_future_route_modules_pages_api_module_compiled__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/dist/server/future/route-modules/pages-api/module.compiled */ \"(api)/./node_modules/next/dist/server/future/route-modules/pages-api/module.compiled.js\");\n/* harmony import */ var next_dist_server_future_route_modules_pages_api_module_compiled__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_future_route_modules_pages_api_module_compiled__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! next/dist/server/future/route-kind */ \"(api)/./node_modules/next/dist/server/future/route-kind.js\");\n/* harmony import */ var next_dist_build_templates_helpers__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! next/dist/build/templates/helpers */ \"(api)/./node_modules/next/dist/build/templates/helpers.js\");\n/* harmony import */ var _src_pages_api_upload_parse_ms_ts__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./src/pages/api/upload-parse-ms.ts */ \"(api)/./src/pages/api/upload-parse-ms.ts\");\nvar __webpack_async_dependencies__ = __webpack_handle_async_dependencies__([_src_pages_api_upload_parse_ms_ts__WEBPACK_IMPORTED_MODULE_3__]);\n_src_pages_api_upload_parse_ms_ts__WEBPACK_IMPORTED_MODULE_3__ = (__webpack_async_dependencies__.then ? (await __webpack_async_dependencies__)() : __webpack_async_dependencies__)[0];\n\n\n\n// Import the userland code.\n\n// Re-export the handler (should be the default export).\n/* harmony default export */ const __WEBPACK_DEFAULT_EXPORT__ = ((0,next_dist_build_templates_helpers__WEBPACK_IMPORTED_MODULE_2__.hoist)(_src_pages_api_upload_parse_ms_ts__WEBPACK_IMPORTED_MODULE_3__, \"default\"));\n// Re-export config.\nconst config = (0,next_dist_build_templates_helpers__WEBPACK_IMPORTED_MODULE_2__.hoist)(_src_pages_api_upload_parse_ms_ts__WEBPACK_IMPORTED_MODULE_3__, \"config\");\n// Create and export the route module that will be consumed.\nconst routeModule = new next_dist_server_future_route_modules_pages_api_module_compiled__WEBPACK_IMPORTED_MODULE_0__.PagesAPIRouteModule({\n    definition: {\n        kind: next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__.RouteKind.PAGES_API,\n        page: \"/api/upload-parse-ms\",\n        pathname: \"/api/upload-parse-ms\",\n        // The following aren't used in production.\n        bundlePath: \"\",\n        filename: \"\"\n    },\n    userland: _src_pages_api_upload_parse_ms_ts__WEBPACK_IMPORTED_MODULE_3__\n});\n\n//# sourceMappingURL=pages-api.js.map\n__webpack_async_result__();\n} catch(e) { __webpack_async_result__(e); } });//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKGFwaSkvLi9ub2RlX21vZHVsZXMvbmV4dC9kaXN0L2J1aWxkL3dlYnBhY2svbG9hZGVycy9uZXh0LXJvdXRlLWxvYWRlci9pbmRleC5qcz9raW5kPVBBR0VTX0FQSSZwYWdlPSUyRmFwaSUyRnVwbG9hZC1wYXJzZS1tcyZwcmVmZXJyZWRSZWdpb249JmFic29sdXRlUGFnZVBhdGg9LiUyRnNyYyUyRnBhZ2VzJTJGYXBpJTJGdXBsb2FkLXBhcnNlLW1zLnRzJm1pZGRsZXdhcmVDb25maWdCYXNlNjQ9ZTMwJTNEISIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUFzRztBQUN2QztBQUNMO0FBQzFEO0FBQytEO0FBQy9EO0FBQ0EsaUVBQWUsd0VBQUssQ0FBQyw4REFBUSxZQUFZLEVBQUM7QUFDMUM7QUFDTyxlQUFlLHdFQUFLLENBQUMsOERBQVE7QUFDcEM7QUFDTyx3QkFBd0IsZ0hBQW1CO0FBQ2xEO0FBQ0EsY0FBYyx5RUFBUztBQUN2QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMLFlBQVk7QUFDWixDQUFDOztBQUVELHFDIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vZW1hdGgtZnJvbnRlbmQvP2U0NTQiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUGFnZXNBUElSb3V0ZU1vZHVsZSB9IGZyb20gXCJuZXh0L2Rpc3Qvc2VydmVyL2Z1dHVyZS9yb3V0ZS1tb2R1bGVzL3BhZ2VzLWFwaS9tb2R1bGUuY29tcGlsZWRcIjtcbmltcG9ydCB7IFJvdXRlS2luZCB9IGZyb20gXCJuZXh0L2Rpc3Qvc2VydmVyL2Z1dHVyZS9yb3V0ZS1raW5kXCI7XG5pbXBvcnQgeyBob2lzdCB9IGZyb20gXCJuZXh0L2Rpc3QvYnVpbGQvdGVtcGxhdGVzL2hlbHBlcnNcIjtcbi8vIEltcG9ydCB0aGUgdXNlcmxhbmQgY29kZS5cbmltcG9ydCAqIGFzIHVzZXJsYW5kIGZyb20gXCIuL3NyYy9wYWdlcy9hcGkvdXBsb2FkLXBhcnNlLW1zLnRzXCI7XG4vLyBSZS1leHBvcnQgdGhlIGhhbmRsZXIgKHNob3VsZCBiZSB0aGUgZGVmYXVsdCBleHBvcnQpLlxuZXhwb3J0IGRlZmF1bHQgaG9pc3QodXNlcmxhbmQsIFwiZGVmYXVsdFwiKTtcbi8vIFJlLWV4cG9ydCBjb25maWcuXG5leHBvcnQgY29uc3QgY29uZmlnID0gaG9pc3QodXNlcmxhbmQsIFwiY29uZmlnXCIpO1xuLy8gQ3JlYXRlIGFuZCBleHBvcnQgdGhlIHJvdXRlIG1vZHVsZSB0aGF0IHdpbGwgYmUgY29uc3VtZWQuXG5leHBvcnQgY29uc3Qgcm91dGVNb2R1bGUgPSBuZXcgUGFnZXNBUElSb3V0ZU1vZHVsZSh7XG4gICAgZGVmaW5pdGlvbjoge1xuICAgICAgICBraW5kOiBSb3V0ZUtpbmQuUEFHRVNfQVBJLFxuICAgICAgICBwYWdlOiBcIi9hcGkvdXBsb2FkLXBhcnNlLW1zXCIsXG4gICAgICAgIHBhdGhuYW1lOiBcIi9hcGkvdXBsb2FkLXBhcnNlLW1zXCIsXG4gICAgICAgIC8vIFRoZSBmb2xsb3dpbmcgYXJlbid0IHVzZWQgaW4gcHJvZHVjdGlvbi5cbiAgICAgICAgYnVuZGxlUGF0aDogXCJcIixcbiAgICAgICAgZmlsZW5hbWU6IFwiXCJcbiAgICB9LFxuICAgIHVzZXJsYW5kXG59KTtcblxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9cGFnZXMtYXBpLmpzLm1hcCJdLCJuYW1lcyI6W10sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(api)/./node_modules/next/dist/build/webpack/loaders/next-route-loader/index.js?kind=PAGES_API&page=%2Fapi%2Fupload-parse-ms&preferredRegion=&absolutePagePath=.%2Fsrc%2Fpages%2Fapi%2Fupload-parse-ms.ts&middlewareConfigBase64=e30%3D!\n");

/***/ }),

/***/ "(api)/./src/pages/api/upload-parse-ms.ts":
/*!******************************************!*\
  !*** ./src/pages/api/upload-parse-ms.ts ***!
  \******************************************/
/***/ ((module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.a(module, async (__webpack_handle_async_dependencies__, __webpack_async_result__) => { try {\n__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   config: () => (/* binding */ config),\n/* harmony export */   \"default\": () => (/* binding */ handler)\n/* harmony export */ });\n/* harmony import */ var formidable__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! formidable */ \"formidable\");\n/* harmony import */ var fs__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! fs */ \"fs\");\n/* harmony import */ var fs__WEBPACK_IMPORTED_MODULE_1___default = /*#__PURE__*/__webpack_require__.n(fs__WEBPACK_IMPORTED_MODULE_1__);\n/* harmony import */ var path__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! path */ \"path\");\n/* harmony import */ var path__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(path__WEBPACK_IMPORTED_MODULE_2__);\n/* harmony import */ var child_process__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! child_process */ \"child_process\");\n/* harmony import */ var child_process__WEBPACK_IMPORTED_MODULE_3___default = /*#__PURE__*/__webpack_require__.n(child_process__WEBPACK_IMPORTED_MODULE_3__);\n/* harmony import */ var crypto__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! crypto */ \"crypto\");\n/* harmony import */ var crypto__WEBPACK_IMPORTED_MODULE_4___default = /*#__PURE__*/__webpack_require__.n(crypto__WEBPACK_IMPORTED_MODULE_4__);\n/* harmony import */ var node_tesseract_ocr__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! node-tesseract-ocr */ \"node-tesseract-ocr\");\n/* harmony import */ var node_tesseract_ocr__WEBPACK_IMPORTED_MODULE_5___default = /*#__PURE__*/__webpack_require__.n(node_tesseract_ocr__WEBPACK_IMPORTED_MODULE_5__);\nvar __webpack_async_dependencies__ = __webpack_handle_async_dependencies__([formidable__WEBPACK_IMPORTED_MODULE_0__]);\nformidable__WEBPACK_IMPORTED_MODULE_0__ = (__webpack_async_dependencies__.then ? (await __webpack_async_dependencies__)() : __webpack_async_dependencies__)[0];\n\n\n\n\n\n\n// If true, use mock/page_x.json instead of calling Python for parsing\nconst MOCK_MODE = false;\nconst config = {\n    api: {\n        bodyParser: false\n    }\n};\nasync function handler(req, res) {\n    let responded = false;\n    if (req.method !== \"POST\") {\n        res.setHeader(\"Allow\", [\n            \"POST\"\n        ]);\n        responded = true;\n        return res.status(405).json({\n            error: `Method ${req.method} Not Allowed`\n        });\n    }\n    const form = new formidable__WEBPACK_IMPORTED_MODULE_0__.IncomingForm({\n        keepExtensions: true\n    });\n    form.parse(req, async (err, fields, files)=>{\n        console.log(\"\\uD83D\\uDCE8 Entered form.parse\");\n        if (err) {\n            responded = true;\n            return res.status(500).json({\n                error: \"Failed to parse form data.\"\n            });\n        }\n        const file = files.pdf?.[0] || files.pdf;\n        console.log(\"\\uD83D\\uDCE6 Uploaded file:\", file);\n        if (!file || Array.isArray(file)) {\n            responded = true;\n            return res.status(400).json({\n                error: \"No file uploaded.\"\n            });\n        }\n        console.log(\"\\uD83D\\uDCE5 File received\", file.filepath);\n        try {\n            const imageDir = path__WEBPACK_IMPORTED_MODULE_2___default().resolve(process.cwd(), \"tmp/markscheme_pages\");\n            fs__WEBPACK_IMPORTED_MODULE_1___default().mkdirSync(imageDir, {\n                recursive: true\n            });\n            // 🧠 调用 detect_tables_in_pdf.py，提前识别评分页\n            console.log(\"\\uD83D\\uDC0D Running detect_tables_in_pdf.py:\", [\n                \"python3\",\n                path__WEBPACK_IMPORTED_MODULE_2___default().resolve(process.cwd(), \"../backend/scripts/detect_tables_in_pdf.py\"),\n                file.filepath\n            ]);\n            const detectProcess = (0,child_process__WEBPACK_IMPORTED_MODULE_3__.spawn)(\"python3\", [\n                path__WEBPACK_IMPORTED_MODULE_2___default().resolve(process.cwd(), \"../backend/scripts/detect_tables_in_pdf.py\"),\n                file.filepath\n            ]);\n            await new Promise((resolve, reject)=>{\n                detectProcess.on(\"close\", (code)=>{\n                    if (code !== 0) {\n                        console.error(\"❌ Table detection failed with code\", code);\n                        reject(new Error(\"Table detection failed\"));\n                    } else {\n                        console.log(\"✅ Table detection finished successfully\");\n                        resolve(null);\n                    }\n                });\n            });\n            const convertProcess = (0,child_process__WEBPACK_IMPORTED_MODULE_3__.spawn)(\"python3\", [\n                path__WEBPACK_IMPORTED_MODULE_2___default().resolve(process.cwd(), \"../backend/scripts/convert_ms_to_images.py\"),\n                file.filepath,\n                imageDir\n            ]);\n            await new Promise((resolve, reject)=>{\n                convertProcess.on(\"close\", (code)=>{\n                    if (code !== 0) reject(new Error(\"Image conversion failed\"));\n                    else resolve(null);\n                });\n            });\n            // Read all images in imageDir sorted by page number\n            const imageFiles = fs__WEBPACK_IMPORTED_MODULE_1___default().readdirSync(imageDir).filter((f)=>/\\.(png|jpe?g|bmp|tiff?|webp)$/i.test(f)).sort((a, b)=>{\n                const numA = parseInt(a.match(/\\d+/)?.[0] || \"0\", 10);\n                const numB = parseInt(b.match(/\\d+/)?.[0] || \"0\", 10);\n                return numA - numB;\n            });\n            const pagesWithTablesPath = path__WEBPACK_IMPORTED_MODULE_2___default().resolve(process.cwd(), \"tmp/pages_with_tables.json\");\n            let pagesStatus = [];\n            if (fs__WEBPACK_IMPORTED_MODULE_1___default().existsSync(pagesWithTablesPath)) {\n                const data = fs__WEBPACK_IMPORTED_MODULE_1___default().readFileSync(pagesWithTablesPath, \"utf8\");\n                const parsed = JSON.parse(data);\n                pagesStatus = parsed.pages || [];\n            } else {\n                console.warn(\"⚠️ pages_with_tables.json not found. Defaulting to process all pages.\");\n            }\n            const marks = [];\n            let noteBuffer = \"\";\n            let lastMarks = [];\n            // Image hash cache: Set of hashes seen so far\n            const seenHashes = new Set();\n            // For reuse: last result from previous image\n            let lastResult = null;\n            let seenFirstHeader = false;\n            let page1Text = \"\";\n            try {\n                for(let i = 0; i < imageFiles.length; ++i){\n                    const pageIndex = i + 1;\n                    const pageStatus = pagesStatus.find((p)=>p.page === pageIndex);\n                    // Debug output for table/header status\n                    console.log(`🔍 Page ${pageIndex} status: has_table=${pageStatus?.has_table}, has_header=${pageStatus?.has_header}`);\n                    if (!pageStatus) {\n                        console.log(`⛔ Skipping Page ${pageIndex} (no status info)`);\n                        lastResult = null;\n                        continue;\n                    }\n                    const imgFile = imageFiles[i];\n                    const imgPath = path__WEBPACK_IMPORTED_MODULE_2___default().resolve(imageDir, imgFile);\n                    // Compute hash for the image\n                    const imgBuffer = fs__WEBPACK_IMPORTED_MODULE_1___default().readFileSync(imgPath);\n                    const imgHash = crypto__WEBPACK_IMPORTED_MODULE_4___default().createHash(\"sha256\").update(imgBuffer).digest(\"hex\");\n                    console.log(`📄 Page ${pageIndex}: hash = ${imgHash}`);\n                    if (pageIndex === 1 && !MOCK_MODE) {\n                        const titleText = await node_tesseract_ocr__WEBPACK_IMPORTED_MODULE_5___default().recognize(imgPath);\n                        page1Text = titleText;\n                        // Removed extraction of paperCode, paperName, examSession and board\n                        // 调试输出: 识别出的试卷信息\n                        console.log(\"\\uD83D\\uDCD8 Extracted Exam Info:\");\n                        console.log(\"\\uD83D\\uDCC4 page1_text:\", page1Text.trim());\n                    }\n                    let jsonOutput = null;\n                    if (seenHashes.has(imgHash)) {\n                        // Reuse last result if hash seen before\n                        console.log(`🔁 Page ${pageIndex}: skipped due to hash match`);\n                        jsonOutput = lastResult;\n                    } else {\n                        seenHashes.add(imgHash);\n                        if (!pageStatus.has_header && seenFirstHeader) {\n                            console.log(`📝 Page ${pageIndex} appended to noteBuffer (no header, after scoring begins)`);\n                            console.log(`📝 Page ${pageIndex}: treated as Notes (no header, after scoring begins)`);\n                            const ocrText = await node_tesseract_ocr__WEBPACK_IMPORTED_MODULE_5___default().recognize(imgPath);\n                            noteBuffer += (noteBuffer ? \"\\n\" : \"\") + ocrText;\n                            lastResult = null;\n                            continue;\n                        }\n                        if (!pageStatus.has_header && !seenFirstHeader) {\n                            console.log(`📄 Page ${pageIndex}: skipped (no header, before scoring)`);\n                            lastResult = null;\n                            continue;\n                        }\n                        seenFirstHeader = true;\n                        // ✅ 此时仅当 hasHeader === true 才会调用 GPT\n                        if (MOCK_MODE) {\n                            // Load mock/page_x.json (x = i+1)\n                            const mockPath = path__WEBPACK_IMPORTED_MODULE_2___default().resolve(process.cwd(), `mock/page_${pageIndex}.json`);\n                            if (!fs__WEBPACK_IMPORTED_MODULE_1___default().existsSync(mockPath)) {\n                                throw new Error(`Mock file not found: ${mockPath}`);\n                            }\n                            const mockData = fs__WEBPACK_IMPORTED_MODULE_1___default().readFileSync(mockPath, \"utf8\");\n                            jsonOutput = JSON.parse(mockData);\n                        } else {\n                            console.log(`📨 Sending image to GPT via parse_markscheme.py: ${imgFile}`);\n                            console.log(\"\\uD83E\\uDDE0 Spawning parse_markscheme.py for\", imgFile);\n                            // Call Python script as before\n                            const parseProcess = (0,child_process__WEBPACK_IMPORTED_MODULE_3__.spawn)(\"python3\", [\n                                path__WEBPACK_IMPORTED_MODULE_2___default().resolve(process.cwd(), \"../backend/scripts/parse_markscheme.py\"),\n                                imgPath\n                            ]);\n                            let stdoutData = \"\";\n                            let stderrData = \"\";\n                            await new Promise((resolve, reject)=>{\n                                parseProcess.stdout.on(\"data\", (data)=>{\n                                    stdoutData += data.toString();\n                                });\n                                parseProcess.stderr.on(\"data\", (data)=>{\n                                    stderrData += data.toString();\n                                    console.log(`🐍 stderr: ${data.toString()}`);\n                                });\n                                parseProcess.on(\"close\", (code)=>{\n                                    console.log(`✅ Python exited with code ${code}`);\n                                    if (code !== 0) {\n                                        reject(new Error(`parse_page.py failed on ${imgFile}: ${stderrData}`));\n                                    } else {\n                                        try {\n                                            // Debug output: show first 2000 chars of GPT raw content\n                                            //console.log(`📥 GPT raw_content for page ${pageIndex}:\\n${stdoutData.slice(0, 2000)}\\n---`);\n                                            //console.log(`📤 Raw JSON from Python for page ${pageIndex}: ${stdoutData.slice(0, 200)}...`);\n                                            jsonOutput = JSON.parse(stdoutData);\n                                            resolve();\n                                        } catch (err) {\n                                            const error = err;\n                                            responded = true;\n                                            return res.status(500).json({\n                                                error: \"Failed to parse pages.\",\n                                                detail: error.message\n                                            });\n                                        }\n                                    }\n                                });\n                            });\n                        }\n                        lastResult = jsonOutput;\n                    }\n                    // Now process jsonOutput as before\n                    const hasMarks = Array.isArray(jsonOutput?.marks) && jsonOutput.marks.length > 0;\n                    if (!hasMarks) {\n                        console.log(`⚠️ No marks on page ${pageIndex}. JSON output was:`, JSON.stringify(jsonOutput, null, 2));\n                        if (jsonOutput?.explanation) {\n                            noteBuffer += (noteBuffer ? \"\\n\" : \"\") + jsonOutput.explanation;\n                        }\n                        continue;\n                    }\n                    // Log before integrating marks\n                    console.log(`📌 Proceeding to integrate marks from page ${pageIndex}...`);\n                    if (Array.isArray(jsonOutput.marks) && jsonOutput.marks.length > 0) {\n                        // 拆分 notes 按评分点标识，合并到 marks（方法 A）\n                        if (noteBuffer) {\n                            const noteLines = noteBuffer.split(/\\n/).map((line)=>line.trim()).filter(Boolean);\n                            // noteChunks: [chunkText, label]\n                            const noteChunks = [];\n                            let currentLabel = \"\";\n                            for (const line of noteLines){\n                                // 检查是否为 label 行 (如 (a), (b), ...)\n                                const labelMatch = line.match(/^\\(([a-z])\\)/i);\n                                if (labelMatch) {\n                                    currentLabel = labelMatch[0]; // e.g., \"(b)\"\n                                    continue;\n                                }\n                                const markStart = /^(\\(?[a-z]+\\)?\\(?[a-z]+\\)?\\s*)?(m1|a1\\*?|b1(ft)?|d?m\\d?)[:：]/i;\n                                if (noteChunks.length === 0 || markStart.test(line)) {\n                                    noteChunks.push([\n                                        line,\n                                        currentLabel\n                                    ]);\n                                } else {\n                                    const last = noteChunks.length - 1;\n                                    noteChunks[last][0] += \" \" + line;\n                                }\n                            }\n                            // 方法A：逐个评分点分配chunk，且每个chunk最多只分配给一个评分点\n                            const usedChunks = new Set();\n                            for (const mark of lastMarks){\n                                const markKey = (mark.label + (mark.mark_code || \"\")).toLowerCase().replace(/[\\s()]/g, \"\");\n                                for(let i = 0; i < noteChunks.length; i++){\n                                    if (usedChunks.has(i)) continue;\n                                    const [chunk, chunkLabel] = noteChunks[i];\n                                    const match = chunk.match(/^(\\(?[a-z]+\\)?\\(?[a-z]+\\)?\\s*)?(m1|a1\\*?|b1(ft)?|d?m\\d?)[:：]/i);\n                                    if (!match) continue;\n                                    const markCodeRaw = (match[2] || \"\").toUpperCase();\n                                    const candidateKey = ((chunkLabel || \"\") + markCodeRaw).toLowerCase().replace(/[\\s()]/g, \"\");\n                                    if (candidateKey === markKey) {\n                                        if (!mark.explanation) mark.explanation = \"\";\n                                        mark.explanation += (mark.explanation ? \"\\n\" : \"\") + chunk;\n                                        usedChunks.add(i);\n                                        console.log(`🧩 Explanation matched for mark: label=${mark.label}, code=${mark.mark_code}`);\n                                        console.log(`⬇️ Explanation content:\\n${chunk}`);\n                                        break;\n                                    }\n                                }\n                            }\n                            // 将未分配的 chunk 追加到最后评分点\n                            const extraChunks = noteChunks.filter((_, i)=>!usedChunks.has(i)).map(([text])=>text);\n                            if (extraChunks.length > 0 && lastMarks.length > 0) {\n                                const lastMark = lastMarks[lastMarks.length - 1];\n                                const extraText = extraChunks.join(\"\\n\");\n                                if (!lastMark.explanation) lastMark.explanation = \"\";\n                                // Add a comment indicating this explanation is from notes continuation\n                                lastMark.explanation += (lastMark.explanation ? \"\\n\" : \"\") + \"[Note continuation]\\n\" + extraText;\n                            }\n                            console.log(`🪄 Final marks for page ${pageIndex}:\\n`, JSON.stringify(lastMarks, null, 2));\n                            noteBuffer = \"\";\n                        }\n                        marks.push(...jsonOutput.marks);\n                        console.log(\"\\uD83D\\uDCCB Merged marks so far:\", marks.length);\n                        console.log(`✅ Page ${pageIndex}: ${jsonOutput.marks.length} marks added`);\n                        console.log(`📬 Received ${jsonOutput.marks.length} marks from GPT for page ${pageIndex}`);\n                        lastMarks = jsonOutput.marks;\n                    }\n                }\n                // Ensure each mark has an 'explanation' property\n                for (const mark of marks){\n                    if (!(\"explanation\" in mark)) {\n                        mark.explanation = \"\";\n                    }\n                }\n                // Write marks to tmp/output_marks.json before returning\n                const outputPath = path__WEBPACK_IMPORTED_MODULE_2___default().resolve(process.cwd(), \"tmp/output_marks.json\");\n                const outputData = JSON.stringify({\n                    marks,\n                    exam_metadata: {\n                        page1_text: page1Text.trim()\n                    }\n                }, null, 2);\n                console.log(\"\\uD83D\\uDCE6 Final JSON content preview:\\n\" + outputData.slice(0, 1000) + \"\\n---\");\n                fs__WEBPACK_IMPORTED_MODULE_1___default().writeFileSync(outputPath, outputData, \"utf8\");\n                console.log(`💾 Final output written to ${outputPath}`);\n                responded = true;\n                return res.status(200).json({\n                    marks,\n                    exam_metadata: {\n                        page1_text: page1Text.trim()\n                    }\n                });\n            } catch (err) {\n                const error = err;\n                responded = true;\n                return res.status(500).json({\n                    error: \"Failed to parse pages.\",\n                    detail: error.message\n                });\n            }\n        } catch (e) {\n            responded = true;\n            return res.status(500).json({\n                error: \"Failed to process PDF.\",\n                detail: e?.message\n            });\n        }\n    });\n}\n\n__webpack_async_result__();\n} catch(e) { __webpack_async_result__(e); } });//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKGFwaSkvLi9zcmMvcGFnZXMvYXBpL3VwbG9hZC1wYXJzZS1tcy50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQTBDO0FBQ3RCO0FBQ0k7QUFFYztBQUNWO0FBQ2U7QUFDM0Msc0VBQXNFO0FBQ3RFLE1BQU1NLFlBQVk7QUFFWCxNQUFNQyxTQUFTO0lBQ3BCQyxLQUFLO1FBQ0hDLFlBQVk7SUFDZDtBQUNGLEVBQUU7QUFFYSxlQUFlQyxRQUFRQyxHQUFtQixFQUFFQyxHQUFvQjtJQUM3RSxJQUFJQyxZQUFZO0lBR2hCLElBQUlGLElBQUlHLE1BQU0sS0FBSyxRQUFRO1FBQ3pCRixJQUFJRyxTQUFTLENBQUMsU0FBUztZQUFDO1NBQU87UUFDL0JGLFlBQVk7UUFDWixPQUFPRCxJQUFJSSxNQUFNLENBQUMsS0FBS0MsSUFBSSxDQUFDO1lBQUVDLE9BQU8sQ0FBQyxPQUFPLEVBQUVQLElBQUlHLE1BQU0sQ0FBQyxZQUFZLENBQUM7UUFBQztJQUMxRTtJQUVBLE1BQU1LLE9BQU8sSUFBSW5CLG9EQUFZQSxDQUFDO1FBQUVvQixnQkFBZ0I7SUFBSztJQUVyREQsS0FBS0UsS0FBSyxDQUFDVixLQUFLLE9BQU9XLEtBQUtDLFFBQVFDO1FBQ2xDQyxRQUFRQyxHQUFHLENBQUM7UUFDWixJQUFJSixLQUFLO1lBQ1BULFlBQVk7WUFDWixPQUFPRCxJQUFJSSxNQUFNLENBQUMsS0FBS0MsSUFBSSxDQUFDO2dCQUFFQyxPQUFPO1lBQTZCO1FBQ3BFO1FBRUEsTUFBTVMsT0FBT0gsTUFBTUksR0FBRyxFQUFFLENBQUMsRUFBRSxJQUFJSixNQUFNSSxHQUFHO1FBQ3hDSCxRQUFRQyxHQUFHLENBQUMsK0JBQXFCQztRQUNqQyxJQUFJLENBQUNBLFFBQVFFLE1BQU1DLE9BQU8sQ0FBQ0gsT0FBTztZQUNoQ2QsWUFBWTtZQUNaLE9BQU9ELElBQUlJLE1BQU0sQ0FBQyxLQUFLQyxJQUFJLENBQUM7Z0JBQUVDLE9BQU87WUFBb0I7UUFDM0Q7UUFFQU8sUUFBUUMsR0FB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VUFBVW1CLElBQUk7b0JBQUc7Z0JBQUUsR0FBRyxNQUFNO2dCQUNwR25FLFFBQVFDLEdBQUcsQ0FBQywrQ0FBcUNrSCxXQUFXRyxLQUFLLENBQUMsR0FBRyxRQUFRO2dCQUM3RTlJLHVEQUFnQixDQUFDMEksWUFBWUMsWUFBWTtnQkFDekNuSCxRQUFRQyxHQUFHLENBQUMsQ0FBQywyQkFBMkIsRUFBRWlILFdBQVcsQ0FBQztnQkFDdEQ5SCxZQUFZO2dCQUNaLE9BQU9ELElBQUlJLE1BQU0sQ0FBQyxLQUFLQyxJQUFJLENBQUM7b0JBQUVpRDtvQkFBTzJFLGVBQWU7d0JBQUVDLFlBQVlyRSxVQUFVbUIsSUFBSTtvQkFBRztnQkFBRTtZQUN2RixFQUFFLE9BQU90RSxLQUFjO2dCQUNyQixNQUFNSixRQUFRSTtnQkFDZFQsWUFBWTtnQkFDWixPQUFPRCxJQUFJSSxNQUFNLENBQUMsS0FBS0MsSUFBSSxDQUFDO29CQUFFQyxPQUFPO29CQUEwQnVGLFFBQVF2RixNQUFNd0YsT0FBTztnQkFBQztZQUN2RjtRQUNGLEVBQUUsT0FBT3VDLEdBQVE7WUFDZnBJLFlBQVk7WUFDWixPQUFPRCxJQUFJSSxNQUFNLENBQUMsS0FBS0MsSUFBSSxDQUFDO2dCQUFFQyxPQUFPO2dCQUEwQnVGLFFBQVF3QyxHQUFHdkM7WUFBUTtRQUNwRjtJQUNGO0FBQ0YiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9lbWF0aC1mcm9udGVuZC8uL3NyYy9wYWdlcy9hcGkvdXBsb2FkLXBhcnNlLW1zLnRzPzFkYTgiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5jb21pbmdGb3JtIH0gZnJvbSBcImZvcm1pZGFibGVcIjtcbmltcG9ydCBmcyBmcm9tIFwiZnNcIjtcbmltcG9ydCBwYXRoIGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgdHlwZSB7IE5leHRBcGlSZXF1ZXN0LCBOZXh0QXBpUmVzcG9uc2UgfSBmcm9tIFwibmV4dFwiO1xuaW1wb3J0IHsgc3Bhd24gfSBmcm9tIFwiY2hpbGRfcHJvY2Vzc1wiO1xuaW1wb3J0IGNyeXB0byBmcm9tIFwiY3J5cHRvXCI7XG5pbXBvcnQgdGVzc2VyYWN0IGZyb20gXCJub2RlLXRlc3NlcmFjdC1vY3JcIjtcbi8vIElmIHRydWUsIHVzZSBtb2NrL3BhZ2VfeC5qc29uIGluc3RlYWQgb2YgY2FsbGluZyBQeXRob24gZm9yIHBhcnNpbmdcbmNvbnN0IE1PQ0tfTU9ERSA9IGZhbHNlO1xuXG5leHBvcnQgY29uc3QgY29uZmlnID0ge1xuICBhcGk6IHtcbiAgICBib2R5UGFyc2VyOiBmYWxzZSxcbiAgfSxcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGFzeW5jIGZ1bmN0aW9uIGhhbmRsZXIocmVxOiBOZXh0QXBpUmVxdWVzdCwgcmVzOiBOZXh0QXBpUmVzcG9uc2UpIHtcbiAgbGV0IHJlc3BvbmRlZCA9IGZhbHNlO1xuXG5cbiAgaWYgKHJlcS5tZXRob2QgIT09IFwiUE9TVFwiKSB7XG4gICAgcmVzLnNldEhlYWRlcihcIkFsbG93XCIsIFtcIlBPU1RcIl0pO1xuICAgIHJlc3BvbmRlZCA9IHRydWU7XG4gICAgcmV0dXJuIHJlcy5zdGF0dXMoNDA1KS5qc29uKHsgZXJyb3I6IGBNZXRob2QgJHtyZXEubWV0aG9kfSBOb3QgQWxsb3dlZGAgfSk7XG4gIH1cblxuICBjb25zdCBmb3JtID0gbmV3IEluY29taW5nRm9ybSh7IGtlZXBFeHRlbnNpb25zOiB0cnVlIH0pO1xuXG4gIGZvcm0ucGFyc2UocmVxLCBhc3luYyAoZXJyLCBmaWVsZHMsIGZpbGVzKSA9PiB7XG4gICAgY29uc29sZS5sb2coXCLwn5OoIEVudGVyZWQgZm9ybS5wYXJzZVwiKTtcbiAgICBpZiAoZXJyKSB7XG4gICAgICByZXNwb25kZWQgPSB0cnVlO1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgZXJyb3I6IFwiRmFpbGVkIHRvIHBhcnNlIGZvcm0gZGF0YS5cIiB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBmaWxlID0gZmlsZXMucGRmPy5bMF0gfHwgZmlsZXMucGRmO1xuICAgIGNvbnNvbGUubG9nKFwi8J+TpiBVcGxvYWRlZCBmaWxlOlwiLCBmaWxlKTtcbiAgICBpZiAoIWZpbGUgfHwgQXJyYXkuaXNBcnJheShmaWxlKSkge1xuICAgICAgcmVzcG9uZGVkID0gdHJ1ZTtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IGVycm9yOiBcIk5vIGZpbGUgdXBsb2FkZWQuXCIgfSk7XG4gICAgfVxuXG4gICAgY29uc29sZS5sb2coXCLwn5OlIEZpbGUgcmVjZWl2ZWRcIiwgZmlsZS5maWxlcGF0aCk7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgaW1hZ2VEaXIgPSBwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwgXCJ0bXAvbWFya3NjaGVtZV9wYWdlc1wiKTtcbiAgICAgIGZzLm1rZGlyU3luYyhpbWFnZURpciwgeyByZWN1cnNpdmU6IHRydWUgfSk7XG5cbiAgICAgIC8vIPCfp6Ag6LCD55SoIGRldGVjdF90YWJsZXNfaW5fcGRmLnB577yM5o+Q5YmN6K+G5Yir6K+E5YiG6aG1XG4gICAgICBjb25zb2xlLmxvZyhcIvCfkI0gUnVubmluZyBkZXRlY3RfdGFibGVzX2luX3BkZi5weTpcIiwgW1xuICAgICAgICBcInB5dGhvbjNcIixcbiAgICAgICAgcGF0aC5yZXNvbHZlKHByb2Nlc3MuY3dkKCksIFwiLi4vYmFja2VuZC9zY3JpcHRzL2RldGVjdF90YWJsZXNfaW5fcGRmLnB5XCIpLFxuICAgICAgICBmaWxlLmZpbGVwYXRoXG4gICAgICBdKTtcbiAgICAgIGNvbnN0IGRldGVjdFByb2Nlc3MgPSBzcGF3bihcInB5dGhvbjNcIiwgW1xuICAgICAgICBwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwgXCIuLi9iYWNrZW5kL3NjcmlwdHMvZGV0ZWN0X3RhYmxlc19pbl9wZGYucHlcIiksXG4gICAgICAgIGZpbGUuZmlsZXBhdGhcbiAgICAgIF0pO1xuXG4gICAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIGRldGVjdFByb2Nlc3Mub24oXCJjbG9zZVwiLCAoY29kZSkgPT4ge1xuICAgICAgICAgIGlmIChjb2RlICE9PSAwKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFwi4p2MIFRhYmxlIGRldGVjdGlvbiBmYWlsZWQgd2l0aCBjb2RlXCIsIGNvZGUpO1xuICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihcIlRhYmxlIGRldGVjdGlvbiBmYWlsZWRcIikpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIuKchSBUYWJsZSBkZXRlY3Rpb24gZmluaXNoZWQgc3VjY2Vzc2Z1bGx5XCIpO1xuICAgICAgICAgICAgcmVzb2x2ZShudWxsKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGNvbnZlcnRQcm9jZXNzID0gc3Bhd24oXCJweXRob24zXCIsIFtcbiAgICAgICAgcGF0aC5yZXNvbHZlKHByb2Nlc3MuY3dkKCksIFwiLi4vYmFja2VuZC9zY3JpcHRzL2NvbnZlcnRfbXNfdG9faW1hZ2VzLnB5XCIpLFxuICAgICAgICBmaWxlLmZpbGVwYXRoLFxuICAgICAgICBpbWFnZURpclxuICAgICAgXSk7XG5cbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgY29udmVydFByb2Nlc3Mub24oXCJjbG9zZVwiLCAoY29kZSkgPT4ge1xuICAgICAgICAgIGlmIChjb2RlICE9PSAwKSByZWplY3QobmV3IEVycm9yKFwiSW1hZ2UgY29udmVyc2lvbiBmYWlsZWRcIikpO1xuICAgICAgICAgIGVsc2UgcmVzb2x2ZShudWxsKTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcblxuICAgICAgLy8gUmVhZCBhbGwgaW1hZ2VzIGluIGltYWdlRGlyIHNvcnRlZCBieSBwYWdlIG51bWJlclxuICAgICAgY29uc3QgaW1hZ2VGaWxlcyA9IGZzLnJlYWRkaXJTeW5jKGltYWdlRGlyKVxuICAgICAgICAuZmlsdGVyKGYgPT4gL1xcLihwbmd8anBlP2d8Ym1wfHRpZmY/fHdlYnApJC9pLnRlc3QoZikpXG4gICAgICAgIC5zb3J0KChhLCBiKSA9PiB7XG4gICAgICAgICAgY29uc3QgbnVtQSA9IHBhcnNlSW50KGEubWF0Y2goL1xcZCsvKT8uWzBdIHx8IFwiMFwiLCAxMCk7XG4gICAgICAgICAgY29uc3QgbnVtQiA9IHBhcnNlSW50KGIubWF0Y2goL1xcZCsvKT8uWzBdIHx8IFwiMFwiLCAxMCk7XG4gICAgICAgICAgcmV0dXJuIG51bUEgLSBudW1CO1xuICAgICAgICB9KTtcblxuICAgICAgY29uc3QgcGFnZXNXaXRoVGFibGVzUGF0aCA9IHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCBcInRtcC9wYWdlc193aXRoX3RhYmxlcy5qc29uXCIpO1xuICAgICAgbGV0IHBhZ2VzU3RhdHVzOiB7IHBhZ2U6IG51bWJlciwgaGFzX3RhYmxlOiBib29sZWFuLCBoYXNfaGVhZGVyOiBib29sZWFuIH1bXSA9IFtdO1xuICAgICAgaWYgKGZzLmV4aXN0c1N5bmMocGFnZXNXaXRoVGFibGVzUGF0aCkpIHtcbiAgICAgICAgY29uc3QgZGF0YSA9IGZzLnJlYWRGaWxlU3luYyhwYWdlc1dpdGhUYWJsZXNQYXRoLCBcInV0ZjhcIik7XG4gICAgICAgIGNvbnN0IHBhcnNlZCA9IEpTT04ucGFyc2UoZGF0YSk7XG4gICAgICAgIHBhZ2VzU3RhdHVzID0gcGFyc2VkLnBhZ2VzIHx8IFtdO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS53YXJuKFwi4pqg77iPIHBhZ2VzX3dpdGhfdGFibGVzLmpzb24gbm90IGZvdW5kLiBEZWZhdWx0aW5nIHRvIHByb2Nlc3MgYWxsIHBhZ2VzLlwiKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgbWFya3M6IGFueVtdID0gW107XG4gICAgICBsZXQgbm90ZUJ1ZmZlciA9IFwiXCI7XG4gICAgICBsZXQgbGFzdE1hcmtzOiBhbnlbXSA9IFtdO1xuICAgICAgLy8gSW1hZ2UgaGFzaCBjYWNoZTogU2V0IG9mIGhhc2hlcyBzZWVuIHNvIGZhclxuICAgICAgY29uc3Qgc2Vlbkhhc2hlcyA9IG5ldyBTZXQ8c3RyaW5nPigpO1xuICAgICAgLy8gRm9yIHJldXNlOiBsYXN0IHJlc3VsdCBmcm9tIHByZXZpb3VzIGltYWdlXG4gICAgICBsZXQgbGFzdFJlc3VsdDogYW55ID0gbnVsbDtcbiAgICAgIGxldCBzZWVuRmlyc3RIZWFkZXIgPSBmYWxzZTtcblxuICAgICAgbGV0IHBhZ2UxVGV4dCA9IFwiXCI7XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW1hZ2VGaWxlcy5sZW5ndGg7ICsraSkge1xuICAgICAgICAgIGNvbnN0IHBhZ2VJbmRleCA9IGkgKyAxO1xuICAgICAgICAgIGNvbnN0IHBhZ2VTdGF0dXMgPSBwYWdlc1N0YXR1cy5maW5kKHAgPT4gcC5wYWdlID09PSBwYWdlSW5kZXgpO1xuICAgICAgICAgIC8vIERlYnVnIG91dHB1dCBmb3IgdGFibGUvaGVhZGVyIHN0YXR1c1xuICAgICAgICAgIGNvbnNvbGUubG9nKGDwn5SNIFBhZ2UgJHtwYWdlSW5kZXh9IHN0YXR1czogaGFzX3RhYmxlPSR7cGFnZVN0YXR1cz8uaGFzX3RhYmxlfSwgaGFzX2hlYWRlcj0ke3BhZ2VTdGF0dXM/Lmhhc19oZWFkZXJ9YCk7XG4gICAgICAgICAgaWYgKCFwYWdlU3RhdHVzKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhg4puUIFNraXBwaW5nIFBhZ2UgJHtwYWdlSW5kZXh9IChubyBzdGF0dXMgaW5mbylgKTtcbiAgICAgICAgICAgIGxhc3RSZXN1bHQgPSBudWxsO1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgY29uc3QgaW1nRmlsZSA9IGltYWdlRmlsZXNbaV07XG4gICAgICAgICAgY29uc3QgaW1nUGF0aCA9IHBhdGgucmVzb2x2ZShpbWFnZURpciwgaW1nRmlsZSk7XG5cbiAgICAgICAgICAvLyBDb21wdXRlIGhhc2ggZm9yIHRoZSBpbWFnZVxuICAgICAgICAgIGNvbnN0IGltZ0J1ZmZlciA9IGZzLnJlYWRGaWxlU3luYyhpbWdQYXRoKTtcbiAgICAgICAgICBjb25zdCBpbWdIYXNoID0gY3J5cHRvLmNyZWF0ZUhhc2goXCJzaGEyNTZcIikudXBkYXRlKGltZ0J1ZmZlcikuZGlnZXN0KFwiaGV4XCIpO1xuXG4gICAgICAgICAgY29uc29sZS5sb2coYPCfk4QgUGFnZSAke3BhZ2VJbmRleH06IGhhc2ggPSAke2ltZ0hhc2h9YCk7XG5cbiAgICAgICAgICBpZiAocGFnZUluZGV4ID09PSAxICYmICFNT0NLX01PREUpIHtcbiAgICAgICAgICAgIGNvbnN0IHRpdGxlVGV4dCA9IGF3YWl0IHRlc3NlcmFjdC5yZWNvZ25pemUoaW1nUGF0aCk7XG4gICAgICAgICAgICBwYWdlMVRleHQgPSB0aXRsZVRleHQ7XG4gICAgICAgICAgICAvLyBSZW1vdmVkIGV4dHJhY3Rpb24gb2YgcGFwZXJDb2RlLCBwYXBlck5hbWUsIGV4YW1TZXNzaW9uIGFuZCBib2FyZFxuICAgICAgICAgICAgLy8g6LCD6K+V6L6T5Ye6OiDor4bliKvlh7rnmoTor5Xljbfkv6Hmga9cbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwi8J+TmCBFeHRyYWN0ZWQgRXhhbSBJbmZvOlwiKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwi8J+ThCBwYWdlMV90ZXh0OlwiLCBwYWdlMVRleHQudHJpbSgpKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBsZXQganNvbk91dHB1dDogYW55ID0gbnVsbDtcbiAgICAgICAgICBpZiAoc2Vlbkhhc2hlcy5oYXMoaW1nSGFzaCkpIHtcbiAgICAgICAgICAgIC8vIFJldXNlIGxhc3QgcmVzdWx0IGlmIGhhc2ggc2VlbiBiZWZvcmVcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGDwn5SBIFBhZ2UgJHtwYWdlSW5kZXh9OiBza2lwcGVkIGR1ZSB0byBoYXNoIG1hdGNoYCk7XG4gICAgICAgICAgICBqc29uT3V0cHV0ID0gbGFzdFJlc3VsdDtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc2Vlbkhhc2hlcy5hZGQoaW1nSGFzaCk7XG5cbiAgICAgICAgICAgIGlmICghcGFnZVN0YXR1cy5oYXNfaGVhZGVyICYmIHNlZW5GaXJzdEhlYWRlcikge1xuICAgICAgICAgICAgICBjb25zb2xlLmxvZyhg8J+TnSBQYWdlICR7cGFnZUluZGV4fSBhcHBlbmRlZCB0byBub3RlQnVmZmVyIChubyBoZWFkZXIsIGFmdGVyIHNjb3JpbmcgYmVnaW5zKWApO1xuICAgICAgICAgICAgICBjb25zb2xlLmxvZyhg8J+TnSBQYWdlICR7cGFnZUluZGV4fTogdHJlYXRlZCBhcyBOb3RlcyAobm8gaGVhZGVyLCBhZnRlciBzY29yaW5nIGJlZ2lucylgKTtcbiAgICAgICAgICAgICAgY29uc3Qgb2NyVGV4dCA9IGF3YWl0IHRlc3NlcmFjdC5yZWNvZ25pemUoaW1nUGF0aCk7XG4gICAgICAgICAgICAgIG5vdGVCdWZmZXIgKz0gKG5vdGVCdWZmZXIgPyBcIlxcblwiIDogXCJcIikgKyBvY3JUZXh0O1xuICAgICAgICAgICAgICBsYXN0UmVzdWx0ID0gbnVsbDtcbiAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIXBhZ2VTdGF0dXMuaGFzX2hlYWRlciAmJiAhc2VlbkZpcnN0SGVhZGVyKSB7XG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKGDwn5OEIFBhZ2UgJHtwYWdlSW5kZXh9OiBza2lwcGVkIChubyBoZWFkZXIsIGJlZm9yZSBzY29yaW5nKWApO1xuICAgICAgICAgICAgICBsYXN0UmVzdWx0ID0gbnVsbDtcbiAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzZWVuRmlyc3RIZWFkZXIgPSB0cnVlO1xuXG4gICAgICAgICAgICAvLyDinIUg5q2k5pe25LuF5b2TIGhhc0hlYWRlciA9PT0gdHJ1ZSDmiY3kvJrosIPnlKggR1BUXG4gICAgICAgICAgICBpZiAoTU9DS19NT0RFKSB7XG4gICAgICAgICAgICAgIC8vIExvYWQgbW9jay9wYWdlX3guanNvbiAoeCA9IGkrMSlcbiAgICAgICAgICAgICAgY29uc3QgbW9ja1BhdGggPSBwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwgYG1vY2svcGFnZV8ke3BhZ2VJbmRleH0uanNvbmApO1xuICAgICAgICAgICAgICBpZiAoIWZzLmV4aXN0c1N5bmMobW9ja1BhdGgpKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBNb2NrIGZpbGUgbm90IGZvdW5kOiAke21vY2tQYXRofWApO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGNvbnN0IG1vY2tEYXRhID0gZnMucmVhZEZpbGVTeW5jKG1vY2tQYXRoLCBcInV0ZjhcIik7XG4gICAgICAgICAgICAgIGpzb25PdXRwdXQgPSBKU09OLnBhcnNlKG1vY2tEYXRhKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKGDwn5OoIFNlbmRpbmcgaW1hZ2UgdG8gR1BUIHZpYSBwYXJzZV9tYXJrc2NoZW1lLnB5OiAke2ltZ0ZpbGV9YCk7XG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwi8J+noCBTcGF3bmluZyBwYXJzZV9tYXJrc2NoZW1lLnB5IGZvclwiLCBpbWdGaWxlKTtcbiAgICAgICAgICAgICAgLy8gQ2FsbCBQeXRob24gc2NyaXB0IGFzIGJlZm9yZVxuICAgICAgICAgICAgICBjb25zdCBwYXJzZVByb2Nlc3MgPSBzcGF3bihcInB5dGhvbjNcIiwgW1xuICAgICAgICAgICAgICAgIHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCBcIi4uL2JhY2tlbmQvc2NyaXB0cy9wYXJzZV9tYXJrc2NoZW1lLnB5XCIpLFxuICAgICAgICAgICAgICAgIGltZ1BhdGgsXG4gICAgICAgICAgICAgIF0pO1xuXG4gICAgICAgICAgICAgIGxldCBzdGRvdXREYXRhID0gXCJcIjtcbiAgICAgICAgICAgICAgbGV0IHN0ZGVyckRhdGEgPSBcIlwiO1xuXG4gICAgICAgICAgICAgIGF3YWl0IG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgICAgICBwYXJzZVByb2Nlc3Muc3Rkb3V0Lm9uKFwiZGF0YVwiLCAoZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgICAgc3Rkb3V0RGF0YSArPSBkYXRhLnRvU3RyaW5nKCk7XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICBwYXJzZVByb2Nlc3Muc3RkZXJyLm9uKFwiZGF0YVwiLCAoZGF0YSkgPT4ge1xuICAgICAgICAgICAgICAgICAgc3RkZXJyRGF0YSArPSBkYXRhLnRvU3RyaW5nKCk7XG4gICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhg8J+QjSBzdGRlcnI6ICR7ZGF0YS50b1N0cmluZygpfWApO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgcGFyc2VQcm9jZXNzLm9uKFwiY2xvc2VcIiwgKGNvZGUpID0+IHtcbiAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGDinIUgUHl0aG9uIGV4aXRlZCB3aXRoIGNvZGUgJHtjb2RlfWApO1xuICAgICAgICAgICAgICAgICAgaWYgKGNvZGUgIT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihgcGFyc2VfcGFnZS5weSBmYWlsZWQgb24gJHtpbWdGaWxlfTogJHtzdGRlcnJEYXRhfWApKTtcbiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgICAgLy8gRGVidWcgb3V0cHV0OiBzaG93IGZpcnN0IDIwMDAgY2hhcnMgb2YgR1BUIHJhdyBjb250ZW50XG4gICAgICAgICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhg8J+TpSBHUFQgcmF3X2NvbnRlbnQgZm9yIHBhZ2UgJHtwYWdlSW5kZXh9OlxcbiR7c3Rkb3V0RGF0YS5zbGljZSgwLCAyMDAwKX1cXG4tLS1gKTtcbiAgICAgICAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKGDwn5OkIFJhdyBKU09OIGZyb20gUHl0aG9uIGZvciBwYWdlICR7cGFnZUluZGV4fTogJHtzdGRvdXREYXRhLnNsaWNlKDAsIDIwMCl9Li4uYCk7XG4gICAgICAgICAgICAgICAgICAgICAganNvbk91dHB1dCA9IEpTT04ucGFyc2Uoc3Rkb3V0RGF0YSk7XG4gICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnI6IHVua25vd24pIHtcbiAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlcnJvciA9IGVyciBhcyBFcnJvcjtcbiAgICAgICAgICAgICAgICAgICAgICByZXNwb25kZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7IGVycm9yOiBcIkZhaWxlZCB0byBwYXJzZSBwYWdlcy5cIiwgZGV0YWlsOiBlcnJvci5tZXNzYWdlIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbGFzdFJlc3VsdCA9IGpzb25PdXRwdXQ7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgLy8gTm93IHByb2Nlc3MganNvbk91dHB1dCBhcyBiZWZvcmVcbiAgICAgICAgICBjb25zdCBoYXNNYXJrcyA9IEFycmF5LmlzQXJyYXkoanNvbk91dHB1dD8ubWFya3MpICYmIGpzb25PdXRwdXQubWFya3MubGVuZ3RoID4gMDtcbiAgICAgICAgICBpZiAoIWhhc01hcmtzKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhg4pqg77iPIE5vIG1hcmtzIG9uIHBhZ2UgJHtwYWdlSW5kZXh9LiBKU09OIG91dHB1dCB3YXM6YCwgSlNPTi5zdHJpbmdpZnkoanNvbk91dHB1dCwgbnVsbCwgMikpO1xuICAgICAgICAgICAgaWYgKGpzb25PdXRwdXQ/LmV4cGxhbmF0aW9uKSB7XG4gICAgICAgICAgICAgIG5vdGVCdWZmZXIgKz0gKG5vdGVCdWZmZXIgPyBcIlxcblwiIDogXCJcIikgKyBqc29uT3V0cHV0LmV4cGxhbmF0aW9uO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgfVxuICAgICAgICAgIC8vIExvZyBiZWZvcmUgaW50ZWdyYXRpbmcgbWFya3NcbiAgICAgICAgICBjb25zb2xlLmxvZyhg8J+TjCBQcm9jZWVkaW5nIHRvIGludGVncmF0ZSBtYXJrcyBmcm9tIHBhZ2UgJHtwYWdlSW5kZXh9Li4uYCk7XG4gICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoanNvbk91dHB1dC5tYXJrcykgJiYganNvbk91dHB1dC5tYXJrcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAvLyDmi4bliIYgbm90ZXMg5oyJ6K+E5YiG54K55qCH6K+G77yM5ZCI5bm25YiwIG1hcmtz77yI5pa55rOVIEHvvIlcbiAgICAgICAgICAgIGlmIChub3RlQnVmZmVyKSB7XG4gICAgICAgICAgICAgIGNvbnN0IG5vdGVMaW5lcyA9IG5vdGVCdWZmZXIuc3BsaXQoL1xcbi8pLm1hcChsaW5lID0+IGxpbmUudHJpbSgpKS5maWx0ZXIoQm9vbGVhbik7XG4gICAgICAgICAgICAgIC8vIG5vdGVDaHVua3M6IFtjaHVua1RleHQsIGxhYmVsXVxuICAgICAgICAgICAgICBjb25zdCBub3RlQ2h1bmtzOiBbc3RyaW5nLCBzdHJpbmddW10gPSBbXTtcbiAgICAgICAgICAgICAgbGV0IGN1cnJlbnRMYWJlbCA9IFwiXCI7XG4gICAgICAgICAgICAgIGZvciAoY29uc3QgbGluZSBvZiBub3RlTGluZXMpIHtcbiAgICAgICAgICAgICAgICAvLyDmo4Dmn6XmmK/lkKbkuLogbGFiZWwg6KGMICjlpoIgKGEpLCAoYiksIC4uLilcbiAgICAgICAgICAgICAgICBjb25zdCBsYWJlbE1hdGNoID0gbGluZS5tYXRjaCgvXlxcKChbYS16XSlcXCkvaSk7XG4gICAgICAgICAgICAgICAgaWYgKGxhYmVsTWF0Y2gpIHtcbiAgICAgICAgICAgICAgICAgIGN1cnJlbnRMYWJlbCA9IGxhYmVsTWF0Y2hbMF07IC8vIGUuZy4sIFwiKGIpXCJcbiAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjb25zdCBtYXJrU3RhcnQgPSAvXihcXCg/W2Etel0rXFwpP1xcKD9bYS16XStcXCk/XFxzKik/KG0xfGExXFwqP3xiMShmdCk/fGQ/bVxcZD8pWzrvvJpdL2k7XG4gICAgICAgICAgICAgICAgaWYgKG5vdGVDaHVua3MubGVuZ3RoID09PSAwIHx8IG1hcmtTdGFydC50ZXN0KGxpbmUpKSB7XG4gICAgICAgICAgICAgICAgICBub3RlQ2h1bmtzLnB1c2goW2xpbmUsIGN1cnJlbnRMYWJlbF0pO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICBjb25zdCBsYXN0ID0gbm90ZUNodW5rcy5sZW5ndGggLSAxO1xuICAgICAgICAgICAgICAgICAgbm90ZUNodW5rc1tsYXN0XVswXSArPSBcIiBcIiArIGxpbmU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgLy8g5pa55rOVQe+8mumAkOS4quivhOWIhueCueWIhumFjWNodW5r77yM5LiU5q+P5LiqY2h1bmvmnIDlpJrlj6rliIbphY3nu5nkuIDkuKror4TliIbngrlcbiAgICAgICAgICAgICAgY29uc3QgdXNlZENodW5rcyA9IG5ldyBTZXQ8bnVtYmVyPigpO1xuICAgICAgICAgICAgICBmb3IgKGNvbnN0IG1hcmsgb2YgbGFzdE1hcmtzKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgbWFya0tleSA9IChtYXJrLmxhYmVsICsgKG1hcmsubWFya19jb2RlIHx8IFwiXCIpKS50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoL1tcXHMoKV0vZywgXCJcIik7XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub3RlQ2h1bmtzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICBpZiAodXNlZENodW5rcy5oYXMoaSkpIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgICAgY29uc3QgW2NodW5rLCBjaHVua0xhYmVsXSA9IG5vdGVDaHVua3NbaV07XG4gICAgICAgICAgICAgICAgICBjb25zdCBtYXRjaCA9IGNodW5rLm1hdGNoKC9eKFxcKD9bYS16XStcXCk/XFwoP1thLXpdK1xcKT9cXHMqKT8obTF8YTFcXCo/fGIxKGZ0KT98ZD9tXFxkPylbOu+8ml0vaSk7XG4gICAgICAgICAgICAgICAgICBpZiAoIW1hdGNoKSBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgIGNvbnN0IG1hcmtDb2RlUmF3ID0gKG1hdGNoWzJdIHx8IFwiXCIpLnRvVXBwZXJDYXNlKCk7XG4gICAgICAgICAgICAgICAgICBjb25zdCBjYW5kaWRhdGVLZXkgPSAoKGNodW5rTGFiZWwgfHwgXCJcIikgKyBtYXJrQ29kZVJhdykudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC9bXFxzKCldL2csIFwiXCIpO1xuICAgICAgICAgICAgICAgICAgaWYgKGNhbmRpZGF0ZUtleSA9PT0gbWFya0tleSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIW1hcmsuZXhwbGFuYXRpb24pIG1hcmsuZXhwbGFuYXRpb24gPSBcIlwiO1xuICAgICAgICAgICAgICAgICAgICBtYXJrLmV4cGxhbmF0aW9uICs9IChtYXJrLmV4cGxhbmF0aW9uID8gXCJcXG5cIiA6IFwiXCIpICsgY2h1bms7XG4gICAgICAgICAgICAgICAgICAgIHVzZWRDaHVua3MuYWRkKGkpO1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhg8J+nqSBFeHBsYW5hdGlvbiBtYXRjaGVkIGZvciBtYXJrOiBsYWJlbD0ke21hcmsubGFiZWx9LCBjb2RlPSR7bWFyay5tYXJrX2NvZGV9YCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGDirIfvuI8gRXhwbGFuYXRpb24gY29udGVudDpcXG4ke2NodW5rfWApO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgLy8g5bCG5pyq5YiG6YWN55qEIGNodW5rIOi/veWKoOWIsOacgOWQjuivhOWIhueCuVxuICAgICAgICAgICAgICBjb25zdCBleHRyYUNodW5rcyA9IG5vdGVDaHVua3MuZmlsdGVyKChfLCBpKSA9PiAhdXNlZENodW5rcy5oYXMoaSkpLm1hcCgoW3RleHRdKSA9PiB0ZXh0KTtcbiAgICAgICAgICAgICAgaWYgKGV4dHJhQ2h1bmtzLmxlbmd0aCA+IDAgJiYgbGFzdE1hcmtzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBjb25zdCBsYXN0TWFyayA9IGxhc3RNYXJrc1tsYXN0TWFya3MubGVuZ3RoIC0gMV07XG4gICAgICAgICAgICAgICAgY29uc3QgZXh0cmFUZXh0ID0gZXh0cmFDaHVua3Muam9pbihcIlxcblwiKTtcbiAgICAgICAgICAgICAgICBpZiAoIWxhc3RNYXJrLmV4cGxhbmF0aW9uKSBsYXN0TWFyay5leHBsYW5hdGlvbiA9IFwiXCI7XG4gICAgICAgICAgICAgICAgLy8gQWRkIGEgY29tbWVudCBpbmRpY2F0aW5nIHRoaXMgZXhwbGFuYXRpb24gaXMgZnJvbSBub3RlcyBjb250aW51YXRpb25cbiAgICAgICAgICAgICAgICBsYXN0TWFyay5leHBsYW5hdGlvbiArPSAobGFzdE1hcmsuZXhwbGFuYXRpb24gPyBcIlxcblwiIDogXCJcIikgKyBcIltOb3RlIGNvbnRpbnVhdGlvbl1cXG5cIiArIGV4dHJhVGV4dDtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBjb25zb2xlLmxvZyhg8J+qhCBGaW5hbCBtYXJrcyBmb3IgcGFnZSAke3BhZ2VJbmRleH06XFxuYCwgSlNPTi5zdHJpbmdpZnkobGFzdE1hcmtzLCBudWxsLCAyKSk7XG4gICAgICAgICAgICAgIG5vdGVCdWZmZXIgPSBcIlwiO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbWFya3MucHVzaCguLi5qc29uT3V0cHV0Lm1hcmtzKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwi8J+TiyBNZXJnZWQgbWFya3Mgc28gZmFyOlwiLCBtYXJrcy5sZW5ndGgpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coYOKchSBQYWdlICR7cGFnZUluZGV4fTogJHtqc29uT3V0cHV0Lm1hcmtzLmxlbmd0aH0gbWFya3MgYWRkZWRgKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGDwn5OsIFJlY2VpdmVkICR7anNvbk91dHB1dC5tYXJrcy5sZW5ndGh9IG1hcmtzIGZyb20gR1BUIGZvciBwYWdlICR7cGFnZUluZGV4fWApO1xuICAgICAgICAgICAgbGFzdE1hcmtzID0ganNvbk91dHB1dC5tYXJrcztcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBFbnN1cmUgZWFjaCBtYXJrIGhhcyBhbiAnZXhwbGFuYXRpb24nIHByb3BlcnR5XG4gICAgICAgIGZvciAoY29uc3QgbWFyayBvZiBtYXJrcykge1xuICAgICAgICAgIGlmICghKFwiZXhwbGFuYXRpb25cIiBpbiBtYXJrKSkge1xuICAgICAgICAgICAgbWFyay5leHBsYW5hdGlvbiA9IFwiXCI7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIC8vIFdyaXRlIG1hcmtzIHRvIHRtcC9vdXRwdXRfbWFya3MuanNvbiBiZWZvcmUgcmV0dXJuaW5nXG4gICAgICAgIGNvbnN0IG91dHB1dFBhdGggPSBwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwgXCJ0bXAvb3V0cHV0X21hcmtzLmpzb25cIik7XG4gICAgICAgIGNvbnN0IG91dHB1dERhdGEgPSBKU09OLnN0cmluZ2lmeSh7IG1hcmtzLCBleGFtX21ldGFkYXRhOiB7IHBhZ2UxX3RleHQ6IHBhZ2UxVGV4dC50cmltKCkgfSB9LCBudWxsLCAyKTtcbiAgICAgICAgY29uc29sZS5sb2coXCLwn5OmIEZpbmFsIEpTT04gY29udGVudCBwcmV2aWV3OlxcblwiICsgb3V0cHV0RGF0YS5zbGljZSgwLCAxMDAwKSArIFwiXFxuLS0tXCIpO1xuICAgICAgICBmcy53cml0ZUZpbGVTeW5jKG91dHB1dFBhdGgsIG91dHB1dERhdGEsIFwidXRmOFwiKTtcbiAgICAgICAgY29uc29sZS5sb2coYPCfkr4gRmluYWwgb3V0cHV0IHdyaXR0ZW4gdG8gJHtvdXRwdXRQYXRofWApO1xuICAgICAgICByZXNwb25kZWQgPSB0cnVlO1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cygyMDApLmpzb24oeyBtYXJrcywgZXhhbV9tZXRhZGF0YTogeyBwYWdlMV90ZXh0OiBwYWdlMVRleHQudHJpbSgpIH0gfSk7XG4gICAgICB9IGNhdGNoIChlcnI6IHVua25vd24pIHtcbiAgICAgICAgY29uc3QgZXJyb3IgPSBlcnIgYXMgRXJyb3I7XG4gICAgICAgIHJlc3BvbmRlZCA9IHRydWU7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7IGVycm9yOiBcIkZhaWxlZCB0byBwYXJzZSBwYWdlcy5cIiwgZGV0YWlsOiBlcnJvci5tZXNzYWdlIH0pO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGU6IGFueSkge1xuICAgICAgcmVzcG9uZGVkID0gdHJ1ZTtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7IGVycm9yOiBcIkZhaWxlZCB0byBwcm9jZXNzIFBERi5cIiwgZGV0YWlsOiBlPy5tZXNzYWdlIH0pO1xuICAgIH1cbiAgfSk7XG59XG4iXSwibmFtZXMiOlsiSW5jb21pbmdGb3JtIiwiZnMiLCJwYXRoIiwic3Bhd24iLCJjcnlwdG8iLCJ0ZXNzZXJhY3QiLCJNT0NLX01PREUiLCJjb25maWciLCJhcGkiLCJib2R5UGFyc2VyIiwiaGFuZGxlciIsInJlcSIsInJlcyIsInJlc3BvbmRlZCIsIm1ldGhvZCIsInNldEhlYWRlciIsInN0YXR1cyIsImpzb24iLCJlcnJvciIsImZvcm0iLCJrZWVwRXh0ZW5zaW9ucyIsInBhcnNlIiwiZXJyIiwiZmllbGRzIiwiZmlsZXMiLCJjb25zb2xlIiwibG9nIiwiZmlsZSIsInBkZiIsIkFycmF5IiwiaXNBcnJheSIsImZpbGVwYXRoIiwiaW1hZ2VEaXIiLCJyZXNvbHZlIiwicHJvY2VzcyIsImN3ZCIsIm1rZGlyU3luYyIsInJlY3Vyc2l2ZSIsImRldGVjdFByb2Nlc3MiLCJQcm9taXNlIiwicmVqZWN0Iiwib24iLCJjb2RlIiwiRXJyb3IiLCJjb252ZXJ0UHJvY2VzcyIsImltYWdlRmlsZXMiLCJyZWFkZGlyU3luYyIsImZpbHRlciIsImYiLCJ0ZXN0Iiwic29ydCIsImEiLCJiIiwibnVtQSIsInBhcnNlSW50IiwibWF0Y2giLCJudW1CIiwicGFnZXNXaXRoVGFibGVzUGF0aCIsInBhZ2VzU3RhdHVzIiwiZXhpc3RzU3luYyIsImRhdGEiLCJyZWFkRmlsZVN5bmMiLCJwYXJzZWQiLCJKU09OIiwicGFnZXMiLCJ3YXJuIiwibWFya3MiLCJub3RlQnVmZmVyIiwibGFzdE1hcmtzIiwic2Vlbkhhc2hlcyIsIlNldCIsImxhc3RSZXN1bHQiLCJzZWVuRmlyc3RIZWFkZXIiLCJwYWdlMVRleHQiLCJpIiwibGVuZ3RoIiwicGFnZUluZGV4IiwicGFnZVN0YXR1cyIsImZpbmQiLCJwIiwicGFnZSIsImhhc190YWJsZSIsImhhc19oZWFkZXIiLCJpbWdGaWxlIiwiaW1nUGF0aCIsImltZ0J1ZmZlciIsImltZ0hhc2giLCJjcmVhdGVIYXNoIiwidXBkYXRlIiwiZGlnZXN0IiwidGl0bGVUZXh0IiwicmVjb2duaXplIiwidHJpbSIsImpzb25PdXRwdXQiLCJoYXMiLCJhZGQiLCJvY3JUZXh0IiwibW9ja1BhdGgiLCJtb2NrRGF0YSIsInBhcnNlUHJvY2VzcyIsInN0ZG91dERhdGEiLCJzdGRlcnJEYXRhIiwic3Rkb3V0IiwidG9TdHJpbmciLCJzdGRlcnIiLCJkZXRhaWwiLCJtZXNzYWdlIiwiaGFzTWFya3MiLCJzdHJpbmdpZnkiLCJleHBsYW5hdGlvbiIsIm5vdGVMaW5lcyIsInNwbGl0IiwibWFwIiwibGluZSIsIkJvb2xlYW4iLCJub3RlQ2h1bmtzIiwiY3VycmVudExhYmVsIiwibGFiZWxNYXRjaCIsIm1hcmtTdGFydCIsInB1c2giLCJsYXN0IiwidXNlZENodW5rcyIsIm1hcmsiLCJtYXJrS2V5IiwibGFiZWwiLCJtYXJrX2NvZGUiLCJ0b0xvd2VyQ2FzZSIsInJlcGxhY2UiLCJjaHVuayIsImNodW5rTGFiZWwiLCJtYXJrQ29kZVJhdyIsInRvVXBwZXJDYXNlIiwiY2FuZGlkYXRlS2V5IiwiZXh0cmFDaHVua3MiLCJfIiwidGV4dCIsImxhc3RNYXJrIiwiZXh0cmFUZXh0Iiwiam9pbiIsIm91dHB1dFBhdGgiLCJvdXRwdXREYXRhIiwiZXhhbV9tZXRhZGF0YSIsInBhZ2UxX3RleHQiLCJzbGljZSIsIndyaXRlRmlsZVN5bmMiLCJlIl0sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(api)/./src/pages/api/upload-parse-ms.ts\n");

/***/ })

};
;

// load runtime
var __webpack_require__ = require("../../webpack-api-runtime.js");
__webpack_require__.C(exports);
var __webpack_exec__ = (moduleId) => (__webpack_require__(__webpack_require__.s = moduleId))
var __webpack_exports__ = __webpack_require__.X(0, ["vendor-chunks/next"], () => (__webpack_exec__("(api)/./node_modules/next/dist/build/webpack/loaders/next-route-loader/index.js?kind=PAGES_API&page=%2Fapi%2Fupload-parse-ms&preferredRegion=&absolutePagePath=.%2Fsrc%2Fpages%2Fapi%2Fupload-parse-ms.ts&middlewareConfigBase64=e30%3D!")));
module.exports = __webpack_exports__;

})();