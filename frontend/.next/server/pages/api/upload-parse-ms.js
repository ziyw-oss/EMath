"use strict";
/*
 * ATTENTION: An "eval-source-map" devtool has been used.
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file with attached SourceMaps in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
(() => {
var exports = {};
exports.id = "pages/api/upload-parse-ms";
exports.ids = ["pages/api/upload-parse-ms"];
exports.modules = {

/***/ "next/dist/compiled/next-server/pages-api.runtime.dev.js":
/*!**************************************************************************!*\
  !*** external "next/dist/compiled/next-server/pages-api.runtime.dev.js" ***!
  \**************************************************************************/
/***/ ((module) => {

module.exports = require("next/dist/compiled/next-server/pages-api.runtime.dev.js");

/***/ }),

/***/ "node-tesseract-ocr":
/*!*************************************!*\
  !*** external "node-tesseract-ocr" ***!
  \*************************************/
/***/ ((module) => {

module.exports = require("node-tesseract-ocr");

/***/ }),

/***/ "formidable":
/*!*****************************!*\
  !*** external "formidable" ***!
  \*****************************/
/***/ ((module) => {

module.exports = import("formidable");;

/***/ }),

/***/ "child_process":
/*!********************************!*\
  !*** external "child_process" ***!
  \********************************/
/***/ ((module) => {

module.exports = require("child_process");

/***/ }),

/***/ "crypto":
/*!*************************!*\
  !*** external "crypto" ***!
  \*************************/
/***/ ((module) => {

module.exports = require("crypto");

/***/ }),

/***/ "fs":
/*!*********************!*\
  !*** external "fs" ***!
  \*********************/
/***/ ((module) => {

module.exports = require("fs");

/***/ }),

/***/ "path":
/*!***********************!*\
  !*** external "path" ***!
  \***********************/
/***/ ((module) => {

module.exports = require("path");

/***/ }),

/***/ "(api)/./node_modules/next/dist/build/webpack/loaders/next-route-loader/index.js?kind=PAGES_API&page=%2Fapi%2Fupload-parse-ms&preferredRegion=&absolutePagePath=.%2Fsrc%2Fpages%2Fapi%2Fupload-parse-ms.ts&middlewareConfigBase64=e30%3D!":
/*!******************************************************************************************************************************************************************************************************************************************!*\
  !*** ./node_modules/next/dist/build/webpack/loaders/next-route-loader/index.js?kind=PAGES_API&page=%2Fapi%2Fupload-parse-ms&preferredRegion=&absolutePagePath=.%2Fsrc%2Fpages%2Fapi%2Fupload-parse-ms.ts&middlewareConfigBase64=e30%3D! ***!
  \******************************************************************************************************************************************************************************************************************************************/
/***/ ((module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.a(module, async (__webpack_handle_async_dependencies__, __webpack_async_result__) => { try {\n__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   config: () => (/* binding */ config),\n/* harmony export */   \"default\": () => (__WEBPACK_DEFAULT_EXPORT__),\n/* harmony export */   routeModule: () => (/* binding */ routeModule)\n/* harmony export */ });\n/* harmony import */ var next_dist_server_future_route_modules_pages_api_module_compiled__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/dist/server/future/route-modules/pages-api/module.compiled */ \"(api)/./node_modules/next/dist/server/future/route-modules/pages-api/module.compiled.js\");\n/* harmony import */ var next_dist_server_future_route_modules_pages_api_module_compiled__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_future_route_modules_pages_api_module_compiled__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! next/dist/server/future/route-kind */ \"(api)/./node_modules/next/dist/server/future/route-kind.js\");\n/* harmony import */ var next_dist_build_templates_helpers__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! next/dist/build/templates/helpers */ \"(api)/./node_modules/next/dist/build/templates/helpers.js\");\n/* harmony import */ var _src_pages_api_upload_parse_ms_ts__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./src/pages/api/upload-parse-ms.ts */ \"(api)/./src/pages/api/upload-parse-ms.ts\");\nvar __webpack_async_dependencies__ = __webpack_handle_async_dependencies__([_src_pages_api_upload_parse_ms_ts__WEBPACK_IMPORTED_MODULE_3__]);\n_src_pages_api_upload_parse_ms_ts__WEBPACK_IMPORTED_MODULE_3__ = (__webpack_async_dependencies__.then ? (await __webpack_async_dependencies__)() : __webpack_async_dependencies__)[0];\n\n\n\n// Import the userland code.\n\n// Re-export the handler (should be the default export).\n/* harmony default export */ const __WEBPACK_DEFAULT_EXPORT__ = ((0,next_dist_build_templates_helpers__WEBPACK_IMPORTED_MODULE_2__.hoist)(_src_pages_api_upload_parse_ms_ts__WEBPACK_IMPORTED_MODULE_3__, \"default\"));\n// Re-export config.\nconst config = (0,next_dist_build_templates_helpers__WEBPACK_IMPORTED_MODULE_2__.hoist)(_src_pages_api_upload_parse_ms_ts__WEBPACK_IMPORTED_MODULE_3__, \"config\");\n// Create and export the route module that will be consumed.\nconst routeModule = new next_dist_server_future_route_modules_pages_api_module_compiled__WEBPACK_IMPORTED_MODULE_0__.PagesAPIRouteModule({\n    definition: {\n        kind: next_dist_server_future_route_kind__WEBPACK_IMPORTED_MODULE_1__.RouteKind.PAGES_API,\n        page: \"/api/upload-parse-ms\",\n        pathname: \"/api/upload-parse-ms\",\n        // The following aren't used in production.\n        bundlePath: \"\",\n        filename: \"\"\n    },\n    userland: _src_pages_api_upload_parse_ms_ts__WEBPACK_IMPORTED_MODULE_3__\n});\n\n//# sourceMappingURL=pages-api.js.map\n__webpack_async_result__();\n} catch(e) { __webpack_async_result__(e); } });//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKGFwaSkvLi9ub2RlX21vZHVsZXMvbmV4dC9kaXN0L2J1aWxkL3dlYnBhY2svbG9hZGVycy9uZXh0LXJvdXRlLWxvYWRlci9pbmRleC5qcz9raW5kPVBBR0VTX0FQSSZwYWdlPSUyRmFwaSUyRnVwbG9hZC1wYXJzZS1tcyZwcmVmZXJyZWRSZWdpb249JmFic29sdXRlUGFnZVBhdGg9LiUyRnNyYyUyRnBhZ2VzJTJGYXBpJTJGdXBsb2FkLXBhcnNlLW1zLnRzJm1pZGRsZXdhcmVDb25maWdCYXNlNjQ9ZTMwJTNEISIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUFzRztBQUN2QztBQUNMO0FBQzFEO0FBQytEO0FBQy9EO0FBQ0EsaUVBQWUsd0VBQUssQ0FBQyw4REFBUSxZQUFZLEVBQUM7QUFDMUM7QUFDTyxlQUFlLHdFQUFLLENBQUMsOERBQVE7QUFDcEM7QUFDTyx3QkFBd0IsZ0hBQW1CO0FBQ2xEO0FBQ0EsY0FBYyx5RUFBUztBQUN2QjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMLFlBQVk7QUFDWixDQUFDOztBQUVELHFDIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vZW1hdGgtZnJvbnRlbmQvP2U0NTQiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUGFnZXNBUElSb3V0ZU1vZHVsZSB9IGZyb20gXCJuZXh0L2Rpc3Qvc2VydmVyL2Z1dHVyZS9yb3V0ZS1tb2R1bGVzL3BhZ2VzLWFwaS9tb2R1bGUuY29tcGlsZWRcIjtcbmltcG9ydCB7IFJvdXRlS2luZCB9IGZyb20gXCJuZXh0L2Rpc3Qvc2VydmVyL2Z1dHVyZS9yb3V0ZS1raW5kXCI7XG5pbXBvcnQgeyBob2lzdCB9IGZyb20gXCJuZXh0L2Rpc3QvYnVpbGQvdGVtcGxhdGVzL2hlbHBlcnNcIjtcbi8vIEltcG9ydCB0aGUgdXNlcmxhbmQgY29kZS5cbmltcG9ydCAqIGFzIHVzZXJsYW5kIGZyb20gXCIuL3NyYy9wYWdlcy9hcGkvdXBsb2FkLXBhcnNlLW1zLnRzXCI7XG4vLyBSZS1leHBvcnQgdGhlIGhhbmRsZXIgKHNob3VsZCBiZSB0aGUgZGVmYXVsdCBleHBvcnQpLlxuZXhwb3J0IGRlZmF1bHQgaG9pc3QodXNlcmxhbmQsIFwiZGVmYXVsdFwiKTtcbi8vIFJlLWV4cG9ydCBjb25maWcuXG5leHBvcnQgY29uc3QgY29uZmlnID0gaG9pc3QodXNlcmxhbmQsIFwiY29uZmlnXCIpO1xuLy8gQ3JlYXRlIGFuZCBleHBvcnQgdGhlIHJvdXRlIG1vZHVsZSB0aGF0IHdpbGwgYmUgY29uc3VtZWQuXG5leHBvcnQgY29uc3Qgcm91dGVNb2R1bGUgPSBuZXcgUGFnZXNBUElSb3V0ZU1vZHVsZSh7XG4gICAgZGVmaW5pdGlvbjoge1xuICAgICAgICBraW5kOiBSb3V0ZUtpbmQuUEFHRVNfQVBJLFxuICAgICAgICBwYWdlOiBcIi9hcGkvdXBsb2FkLXBhcnNlLW1zXCIsXG4gICAgICAgIHBhdGhuYW1lOiBcIi9hcGkvdXBsb2FkLXBhcnNlLW1zXCIsXG4gICAgICAgIC8vIFRoZSBmb2xsb3dpbmcgYXJlbid0IHVzZWQgaW4gcHJvZHVjdGlvbi5cbiAgICAgICAgYnVuZGxlUGF0aDogXCJcIixcbiAgICAgICAgZmlsZW5hbWU6IFwiXCJcbiAgICB9LFxuICAgIHVzZXJsYW5kXG59KTtcblxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9cGFnZXMtYXBpLmpzLm1hcCJdLCJuYW1lcyI6W10sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(api)/./node_modules/next/dist/build/webpack/loaders/next-route-loader/index.js?kind=PAGES_API&page=%2Fapi%2Fupload-parse-ms&preferredRegion=&absolutePagePath=.%2Fsrc%2Fpages%2Fapi%2Fupload-parse-ms.ts&middlewareConfigBase64=e30%3D!\n");

/***/ }),

/***/ "(api)/./src/pages/api/upload-parse-ms.ts":
/*!******************************************!*\
  !*** ./src/pages/api/upload-parse-ms.ts ***!
  \******************************************/
/***/ ((module, __webpack_exports__, __webpack_require__) => {

eval("__webpack_require__.a(module, async (__webpack_handle_async_dependencies__, __webpack_async_result__) => { try {\n__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   config: () => (/* binding */ config),\n/* harmony export */   \"default\": () => (/* binding */ handler)\n/* harmony export */ });\n/* harmony import */ var formidable__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! formidable */ \"formidable\");\n/* harmony import */ var fs__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! fs */ \"fs\");\n/* harmony import */ var fs__WEBPACK_IMPORTED_MODULE_1___default = /*#__PURE__*/__webpack_require__.n(fs__WEBPACK_IMPORTED_MODULE_1__);\n/* harmony import */ var path__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! path */ \"path\");\n/* harmony import */ var path__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(path__WEBPACK_IMPORTED_MODULE_2__);\n/* harmony import */ var child_process__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! child_process */ \"child_process\");\n/* harmony import */ var child_process__WEBPACK_IMPORTED_MODULE_3___default = /*#__PURE__*/__webpack_require__.n(child_process__WEBPACK_IMPORTED_MODULE_3__);\n/* harmony import */ var crypto__WEBPACK_IMPORTED_MODULE_4__ = __webpack_require__(/*! crypto */ \"crypto\");\n/* harmony import */ var crypto__WEBPACK_IMPORTED_MODULE_4___default = /*#__PURE__*/__webpack_require__.n(crypto__WEBPACK_IMPORTED_MODULE_4__);\n/* harmony import */ var node_tesseract_ocr__WEBPACK_IMPORTED_MODULE_5__ = __webpack_require__(/*! node-tesseract-ocr */ \"node-tesseract-ocr\");\n/* harmony import */ var node_tesseract_ocr__WEBPACK_IMPORTED_MODULE_5___default = /*#__PURE__*/__webpack_require__.n(node_tesseract_ocr__WEBPACK_IMPORTED_MODULE_5__);\nvar __webpack_async_dependencies__ = __webpack_handle_async_dependencies__([formidable__WEBPACK_IMPORTED_MODULE_0__]);\nformidable__WEBPACK_IMPORTED_MODULE_0__ = (__webpack_async_dependencies__.then ? (await __webpack_async_dependencies__)() : __webpack_async_dependencies__)[0];\n\n\n\n\n\n\n// If true, use mock/page_x.json instead of calling Python for parsing\nconst MOCK_MODE = false;\nconst config = {\n    api: {\n        bodyParser: false\n    }\n};\nasync function handler(req, res) {\n    let responded = false;\n    if (req.method !== \"POST\") {\n        res.setHeader(\"Allow\", [\n            \"POST\"\n        ]);\n        responded = true;\n        return res.status(405).json({\n            error: `Method ${req.method} Not Allowed`\n        });\n    }\n    const form = new formidable__WEBPACK_IMPORTED_MODULE_0__.IncomingForm({\n        keepExtensions: true\n    });\n    form.parse(req, async (err, fields, files)=>{\n        console.log(\"\\uD83D\\uDCE8 Entered form.parse\");\n        if (err) {\n            responded = true;\n            return res.status(500).json({\n                error: \"Failed to parse form data.\"\n            });\n        }\n        const file = files.pdf?.[0] || files.pdf;\n        console.log(\"\\uD83D\\uDCE6 Uploaded file:\", file);\n        if (!file || Array.isArray(file)) {\n            responded = true;\n            return res.status(400).json({\n                error: \"No file uploaded.\"\n            });\n        }\n        console.log(\"\\uD83D\\uDCE5 File received\", file.filepath);\n        try {\n            const imageDir = path__WEBPACK_IMPORTED_MODULE_2___default().resolve(process.cwd(), \"tmp/markscheme_pages\");\n            fs__WEBPACK_IMPORTED_MODULE_1___default().mkdirSync(imageDir, {\n                recursive: true\n            });\n            // 🧠 调用 detect_tables_in_pdf.py，提前识别评分页\n            console.log(\"\\uD83D\\uDC0D Running detect_tables_in_pdf.py:\", [\n                \"python3\",\n                path__WEBPACK_IMPORTED_MODULE_2___default().resolve(process.cwd(), \"../backend/scripts/detect_tables_in_pdf.py\"),\n                file.filepath\n            ]);\n            const detectProcess = (0,child_process__WEBPACK_IMPORTED_MODULE_3__.spawn)(\"python3\", [\n                path__WEBPACK_IMPORTED_MODULE_2___default().resolve(process.cwd(), \"../backend/scripts/detect_tables_in_pdf.py\"),\n                file.filepath\n            ]);\n            await new Promise((resolve, reject)=>{\n                detectProcess.on(\"close\", (code)=>{\n                    if (code !== 0) {\n                        console.error(\"❌ Table detection failed with code\", code);\n                        reject(new Error(\"Table detection failed\"));\n                    } else {\n                        console.log(\"✅ Table detection finished successfully\");\n                        resolve(null);\n                    }\n                });\n            });\n            const convertProcess = (0,child_process__WEBPACK_IMPORTED_MODULE_3__.spawn)(\"python3\", [\n                path__WEBPACK_IMPORTED_MODULE_2___default().resolve(process.cwd(), \"../backend/scripts/convert_ms_to_images.py\"),\n                file.filepath,\n                imageDir\n            ]);\n            await new Promise((resolve, reject)=>{\n                convertProcess.on(\"close\", (code)=>{\n                    if (code !== 0) reject(new Error(\"Image conversion failed\"));\n                    else resolve(null);\n                });\n            });\n            // Read all images in imageDir sorted by page number\n            const imageFiles = fs__WEBPACK_IMPORTED_MODULE_1___default().readdirSync(imageDir).filter((f)=>/\\.(png|jpe?g|bmp|tiff?|webp)$/i.test(f)).sort((a, b)=>{\n                const numA = parseInt(a.match(/\\d+/)?.[0] || \"0\", 10);\n                const numB = parseInt(b.match(/\\d+/)?.[0] || \"0\", 10);\n                return numA - numB;\n            });\n            const pagesWithTablesPath = path__WEBPACK_IMPORTED_MODULE_2___default().resolve(process.cwd(), \"tmp/pages_with_tables.json\");\n            let pagesStatus = [];\n            if (fs__WEBPACK_IMPORTED_MODULE_1___default().existsSync(pagesWithTablesPath)) {\n                const data = fs__WEBPACK_IMPORTED_MODULE_1___default().readFileSync(pagesWithTablesPath, \"utf8\");\n                const parsed = JSON.parse(data);\n                pagesStatus = parsed.pages || [];\n            } else {\n                console.warn(\"⚠️ pages_with_tables.json not found. Defaulting to process all pages.\");\n            }\n            const marks = [];\n            let noteBuffer = \"\";\n            let lastMarks = [];\n            // Image hash cache: Set of hashes seen so far\n            const seenHashes = new Set();\n            // For reuse: last result from previous image\n            let lastResult = null;\n            let seenFirstHeader = false;\n            try {\n                for(let i = 0; i < imageFiles.length; ++i){\n                    const pageIndex = i + 1;\n                    const pageStatus = pagesStatus.find((p)=>p.page === pageIndex);\n                    if (!pageStatus || !pageStatus.has_table) {\n                        console.log(`⛔ Skipping Page ${pageIndex} (no table)`);\n                        lastResult = null;\n                        continue;\n                    }\n                    const imgFile = imageFiles[i];\n                    const imgPath = path__WEBPACK_IMPORTED_MODULE_2___default().resolve(imageDir, imgFile);\n                    // Compute hash for the image\n                    const imgBuffer = fs__WEBPACK_IMPORTED_MODULE_1___default().readFileSync(imgPath);\n                    const imgHash = crypto__WEBPACK_IMPORTED_MODULE_4___default().createHash(\"sha256\").update(imgBuffer).digest(\"hex\");\n                    console.log(`📄 Page ${pageIndex}: hash = ${imgHash}`);\n                    let jsonOutput = null;\n                    if (seenHashes.has(imgHash)) {\n                        // Reuse last result if hash seen before\n                        console.log(`🔁 Page ${pageIndex}: skipped due to hash match`);\n                        jsonOutput = lastResult;\n                    } else {\n                        seenHashes.add(imgHash);\n                        if (!pageStatus.has_header && seenFirstHeader) {\n                            console.log(`📝 Page ${pageIndex}: treated as Notes (table w/o header, after scoring begins)`);\n                            const ocrText = await node_tesseract_ocr__WEBPACK_IMPORTED_MODULE_5___default().recognize(imgPath);\n                            noteBuffer += (noteBuffer ? \"\\n\" : \"\") + ocrText;\n                            lastResult = null;\n                            continue;\n                        }\n                        if (!pageStatus.has_header && !seenFirstHeader) {\n                            console.log(`📄 Page ${pageIndex}: skipped (table w/o header, before scoring)`);\n                            lastResult = null;\n                            continue;\n                        }\n                        seenFirstHeader = true;\n                        // ✅ 此时仅当 hasHeader === true 才会调用 GPT\n                        if (MOCK_MODE) {\n                            // Load mock/page_x.json (x = i+1)\n                            const mockPath = path__WEBPACK_IMPORTED_MODULE_2___default().resolve(process.cwd(), `mock/page_${pageIndex}.json`);\n                            if (!fs__WEBPACK_IMPORTED_MODULE_1___default().existsSync(mockPath)) {\n                                throw new Error(`Mock file not found: ${mockPath}`);\n                            }\n                            const mockData = fs__WEBPACK_IMPORTED_MODULE_1___default().readFileSync(mockPath, \"utf8\");\n                            jsonOutput = JSON.parse(mockData);\n                        } else {\n                            console.log(`📨 Sending image to GPT via parse_markscheme.py: ${imgFile}`);\n                            console.log(\"\\uD83E\\uDDE0 Spawning parse_markscheme.py for\", imgFile);\n                            // Call Python script as before\n                            const parseProcess = (0,child_process__WEBPACK_IMPORTED_MODULE_3__.spawn)(\"python3\", [\n                                path__WEBPACK_IMPORTED_MODULE_2___default().resolve(process.cwd(), \"../backend/scripts/parse_markscheme.py\"),\n                                imgPath\n                            ]);\n                            let stdoutData = \"\";\n                            let stderrData = \"\";\n                            await new Promise((resolve, reject)=>{\n                                parseProcess.stdout.on(\"data\", (data)=>{\n                                    stdoutData += data.toString();\n                                });\n                                parseProcess.stderr.on(\"data\", (data)=>{\n                                    stderrData += data.toString();\n                                    console.log(`🐍 stderr: ${data.toString()}`);\n                                });\n                                parseProcess.on(\"close\", (code)=>{\n                                    console.log(`✅ Python exited with code ${code}`);\n                                    if (code !== 0) {\n                                        reject(new Error(`parse_page.py failed on ${imgFile}: ${stderrData}`));\n                                    } else {\n                                        try {\n                                            console.log(`📤 Raw JSON from Python for page ${pageIndex}: ${stdoutData.slice(0, 200)}...`);\n                                            jsonOutput = JSON.parse(stdoutData);\n                                            resolve();\n                                        } catch (err) {\n                                            const error = err;\n                                            responded = true;\n                                            return res.status(500).json({\n                                                error: \"Failed to parse pages.\",\n                                                detail: error.message\n                                            });\n                                        }\n                                    }\n                                });\n                            });\n                        }\n                        lastResult = jsonOutput;\n                    }\n                    // Now process jsonOutput as before\n                    if (!jsonOutput || !jsonOutput.header) {\n                        // No header means this page is explanation content\n                        if (jsonOutput?.explanation) {\n                            noteBuffer += (noteBuffer ? \"\\n\" : \"\") + jsonOutput.explanation;\n                        }\n                        continue;\n                    }\n                    if (Array.isArray(jsonOutput.marks) && jsonOutput.marks.length > 0) {\n                        // 拆分 notes 按评分点标识，合并到 marks\n                        if (noteBuffer) {\n                            const noteLines = noteBuffer.split(/\\n/).map((line)=>line.trim()).filter(Boolean);\n                            const noteChunks = [];\n                            // 组装每个评分点段落（支持多行合并）\n                            for (const line of noteLines){\n                                const markStart = /^(\\(?[a-z]+\\)?\\(?[a-z]+\\)?\\s*)?(m1|a1\\*?|b1(ft)?|d?m\\d?)[:：]/i;\n                                if (noteChunks.length === 0 || markStart.test(line)) {\n                                    noteChunks.push(line);\n                                } else {\n                                    noteChunks[noteChunks.length - 1] += \" \" + line;\n                                }\n                            }\n                            // 建立评分点查找索引\n                            const markIndex = new Map();\n                            for (const mark of jsonOutput.marks){\n                                const markKey = (mark.label + (mark.mark_code || \"\")).toLowerCase().replace(/[\\s()]/g, \"\");\n                                markIndex.set(markKey, mark);\n                            }\n                            // 按标识查找并赋值\n                            for (const chunk of noteChunks){\n                                const match = chunk.match(/^(\\(?[a-z]+\\)?\\(?[a-z]+\\)?\\s*)?(m1|a1\\*?|b1(ft)?|d?m\\d?)[:：]/i);\n                                if (!match) continue;\n                                const labelRaw = (match[1] || \"\").trim();\n                                const markCodeRaw = (match[2] || \"\").toUpperCase();\n                                const label = labelRaw.replace(/\\s+/g, \"\");\n                                const markKey = (label + markCodeRaw).toLowerCase().replace(/[\\s()]/g, \"\");\n                                const mark = markIndex.get(markKey);\n                                if (mark) {\n                                    if (!mark.explanation) mark.explanation = \"\";\n                                    mark.explanation += (mark.explanation ? \"\\n\" : \"\") + chunk;\n                                }\n                            }\n                            noteBuffer = \"\";\n                        }\n                        marks.push(...jsonOutput.marks);\n                        console.log(`✅ Page ${pageIndex}: ${jsonOutput.marks.length} marks added`);\n                        console.log(`📬 Received ${jsonOutput.marks.length} marks from GPT for page ${pageIndex}`);\n                        lastMarks = jsonOutput.marks;\n                    }\n                }\n                // Ensure each mark has an 'explanation' property\n                for (const mark of marks){\n                    if (!(\"explanation\" in mark)) {\n                        mark.explanation = \"\";\n                    }\n                }\n                // Write marks to tmp/output_marks.json before returning\n                const outputPath = path__WEBPACK_IMPORTED_MODULE_2___default().resolve(process.cwd(), \"tmp/output_marks.json\");\n                fs__WEBPACK_IMPORTED_MODULE_1___default().writeFileSync(outputPath, JSON.stringify({\n                    marks\n                }, null, 2), \"utf8\");\n                console.log(`💾 Final output written to ${outputPath}`);\n                responded = true;\n                return res.status(200).json({\n                    marks\n                });\n            } catch (err) {\n                const error = err;\n                responded = true;\n                return res.status(500).json({\n                    error: \"Failed to parse pages.\",\n                    detail: error.message\n                });\n            }\n        } catch (e) {\n            responded = true;\n            return res.status(500).json({\n                error: \"Failed to process PDF.\",\n                detail: e?.message\n            });\n        }\n    });\n}\n\n__webpack_async_result__();\n} catch(e) { __webpack_async_result__(e); } });//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKGFwaSkvLi9zcmMvcGFnZXMvYXBpL3VwbG9hZC1wYXJzZS1tcy50cyIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQTBDO0FBQ3RCO0FBQ0k7QUFFYztBQUNWO0FBQ2U7QUFDM0Msc0VBQXNFO0FBQ3RFLE1BQU1NLFlBQVk7QUFFWCxNQUFNQyxTQUFTO0lBQ3BCQyxLQUFLO1FBQ0hDLFlBQVk7SUFDZDtBQUNGLEVBQUU7QUFFYSxlQUFlQyxRQUFRQyxHQUFtQixFQUFFQyxHQUFvQjtJQUM3RSxJQUFJQyxZQUFZO0lBR2hCLElBQUlGLElBQUlHLE1BQU0sS0FBSyxRQUFRO1FBQ3pCRixJQUFJRyxTQUFTLENBQUMsU0FBUztZQUFDO1NBQU87UUFDL0JGLFlBQVk7UUFDWixPQUFPRCxJQUFJSSxNQUFNLENBQUMsS0FBS0MsSUFBSSxDQUFDO1lBQUVDLE9BQU8sQ0FBQyxPQUFPLEVBQUVQLElBQUlHLE1BQU0sQ0FBQyxZQUFZLENBQUM7UUFBQztJQUMxRTtJQUVBLE1BQU1LLE9BQU8sSUFBSW5CLG9EQUFZQSxDQUFDO1FBQUVvQixnQkFBZ0I7SUFBSztJQUVyREQsS0FBS0UsS0FBSyxDQUFDVixLQUFLLE9BQU9XLEtBQUtDLFFBQVFDO1FBQ2xDQyxRQUFRQyxHQUFHLENBQUM7UUFDWixJQUFJSixLQUFLO1lBQ1BULFlBQVk7WUFDWixPQUFPRCxJQUFJSSxNQUFNLENBQUMsS0FBS0MsSUFBSSxDQUFDO2dCQUFFQyxPQUFPO1lBQTZCO1FBQ3BFO1FBRUEsTUFBTVMsT0FBT0gsTUFBTUksR0FBRyxFQUFFLENBQUMsRUFBRSxJQUFJSixNQUFNSSxHQUFHO1FBQ3hDSCxRQUFRQyxHQUFHLENBQUMsK0JBQXFCQztRQUNqQyxJQUFJLENBQUNBLFFBQVFFLE1BQU1DLE9BQU8sQ0FBQ0gsT0FBTztZQUNoQ2QsWUFBWTtZQUNaLE9BQU9ELElBQUlJLE1BQU0sQ0FBQyxLQUFLQyxJQUFJLENBQUM7Z0JBQUVDLE9BQU87WUFBb0I7UUFDM0Q7UUFFQU8sUUFBUUMsR0FB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WSxDQUFDO3dCQUN6RWpELFFBQVFDLEdBQUcsQ0FBQyxDQUFDLFlBQVksRUFBRThELFdBQVd0QixLQUFLLENBQUNRLE1BQU0sQ0FBQyx5QkFBeUIsRUFBRUMsVUFBVSxDQUFDO3dCQUN6RlAsWUFBWW9CLFdBQVd0QixLQUFLO29CQUM5QjtnQkFDRjtnQkFFQSxpREFBaUQ7Z0JBQ2pELEtBQUssTUFBTW9ELFFBQVFwRCxNQUFPO29CQUN4QixJQUFJLENBQUUsa0JBQWlCb0QsSUFBRyxHQUFJO3dCQUM1QkEsS0FBS1osV0FBVyxHQUFHO29CQUNyQjtnQkFDRjtnQkFDQSx3REFBd0Q7Z0JBQ3hELE1BQU13QixhQUFhaEksbURBQVksQ0FBQ2dDLFFBQVFDLEdBQUcsSUFBSTtnQkFDL0NsQyx1REFBZ0IsQ0FBQ2lJLFlBQVluRSxLQUFLcUUsU0FBUyxDQUFDO29CQUFFbEU7Z0JBQU0sR0FBRyxNQUFNLElBQUk7Z0JBQ2pFekMsUUFBUUMsR0FBRyxDQUFDLENBQUMsMkJBQTJCLEVBQUV3RyxXQUFXLENBQUM7Z0JBQ3REckgsWUFBWTtnQkFDWixPQUFPRCxJQUFJSSxNQUFNLENBQUMsS0FBS0MsSUFBSSxDQUFDO29CQUFFaUQ7Z0JBQU07WUFDdEMsRUFBRSxPQUFPNUMsS0FBYztnQkFDckIsTUFBTUosUUFBUUk7Z0JBQ2RULFlBQVk7Z0JBQ1osT0FBT0QsSUFBSUksTUFBTSxDQUFDLEtBQUtDLElBQUksQ0FBQztvQkFBRUMsT0FBTztvQkFBMEJxRixRQUFRckYsTUFBTXNGLE9BQU87Z0JBQUM7WUFDdkY7UUFDRixFQUFFLE9BQU82QixHQUFRO1lBQ2Z4SCxZQUFZO1lBQ1osT0FBT0QsSUFBSUksTUFBTSxDQUFDLEtBQUtDLElBQUksQ0FBQztnQkFBRUMsT0FBTztnQkFBMEJxRixRQUFROEIsR0FBRzdCO1lBQVE7UUFDcEY7SUFDRjtBQUNGIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vZW1hdGgtZnJvbnRlbmQvLi9zcmMvcGFnZXMvYXBpL3VwbG9hZC1wYXJzZS1tcy50cz8xZGE4Il0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluY29taW5nRm9ybSB9IGZyb20gXCJmb3JtaWRhYmxlXCI7XG5pbXBvcnQgZnMgZnJvbSBcImZzXCI7XG5pbXBvcnQgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0IHR5cGUgeyBOZXh0QXBpUmVxdWVzdCwgTmV4dEFwaVJlc3BvbnNlIH0gZnJvbSBcIm5leHRcIjtcbmltcG9ydCB7IHNwYXduIH0gZnJvbSBcImNoaWxkX3Byb2Nlc3NcIjtcbmltcG9ydCBjcnlwdG8gZnJvbSBcImNyeXB0b1wiO1xuaW1wb3J0IHRlc3NlcmFjdCBmcm9tIFwibm9kZS10ZXNzZXJhY3Qtb2NyXCI7XG4vLyBJZiB0cnVlLCB1c2UgbW9jay9wYWdlX3guanNvbiBpbnN0ZWFkIG9mIGNhbGxpbmcgUHl0aG9uIGZvciBwYXJzaW5nXG5jb25zdCBNT0NLX01PREUgPSBmYWxzZTtcblxuZXhwb3J0IGNvbnN0IGNvbmZpZyA9IHtcbiAgYXBpOiB7XG4gICAgYm9keVBhcnNlcjogZmFsc2UsXG4gIH0sXG59O1xuXG5leHBvcnQgZGVmYXVsdCBhc3luYyBmdW5jdGlvbiBoYW5kbGVyKHJlcTogTmV4dEFwaVJlcXVlc3QsIHJlczogTmV4dEFwaVJlc3BvbnNlKSB7XG4gIGxldCByZXNwb25kZWQgPSBmYWxzZTtcblxuXG4gIGlmIChyZXEubWV0aG9kICE9PSBcIlBPU1RcIikge1xuICAgIHJlcy5zZXRIZWFkZXIoXCJBbGxvd1wiLCBbXCJQT1NUXCJdKTtcbiAgICByZXNwb25kZWQgPSB0cnVlO1xuICAgIHJldHVybiByZXMuc3RhdHVzKDQwNSkuanNvbih7IGVycm9yOiBgTWV0aG9kICR7cmVxLm1ldGhvZH0gTm90IEFsbG93ZWRgIH0pO1xuICB9XG5cbiAgY29uc3QgZm9ybSA9IG5ldyBJbmNvbWluZ0Zvcm0oeyBrZWVwRXh0ZW5zaW9uczogdHJ1ZSB9KTtcblxuICBmb3JtLnBhcnNlKHJlcSwgYXN5bmMgKGVyciwgZmllbGRzLCBmaWxlcykgPT4ge1xuICAgIGNvbnNvbGUubG9nKFwi8J+TqCBFbnRlcmVkIGZvcm0ucGFyc2VcIik7XG4gICAgaWYgKGVycikge1xuICAgICAgcmVzcG9uZGVkID0gdHJ1ZTtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7IGVycm9yOiBcIkZhaWxlZCB0byBwYXJzZSBmb3JtIGRhdGEuXCIgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgZmlsZSA9IGZpbGVzLnBkZj8uWzBdIHx8IGZpbGVzLnBkZjtcbiAgICBjb25zb2xlLmxvZyhcIvCfk6YgVXBsb2FkZWQgZmlsZTpcIiwgZmlsZSk7XG4gICAgaWYgKCFmaWxlIHx8IEFycmF5LmlzQXJyYXkoZmlsZSkpIHtcbiAgICAgIHJlc3BvbmRlZCA9IHRydWU7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBlcnJvcjogXCJObyBmaWxlIHVwbG9hZGVkLlwiIH0pO1xuICAgIH1cblxuICAgIGNvbnNvbGUubG9nKFwi8J+TpSBGaWxlIHJlY2VpdmVkXCIsIGZpbGUuZmlsZXBhdGgpO1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGltYWdlRGlyID0gcGF0aC5yZXNvbHZlKHByb2Nlc3MuY3dkKCksIFwidG1wL21hcmtzY2hlbWVfcGFnZXNcIik7XG4gICAgICBmcy5ta2RpclN5bmMoaW1hZ2VEaXIsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuXG4gICAgICAvLyDwn6egIOiwg+eUqCBkZXRlY3RfdGFibGVzX2luX3BkZi5wee+8jOaPkOWJjeivhuWIq+ivhOWIhumhtVxuICAgICAgY29uc29sZS5sb2coXCLwn5CNIFJ1bm5pbmcgZGV0ZWN0X3RhYmxlc19pbl9wZGYucHk6XCIsIFtcbiAgICAgICAgXCJweXRob24zXCIsXG4gICAgICAgIHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCBcIi4uL2JhY2tlbmQvc2NyaXB0cy9kZXRlY3RfdGFibGVzX2luX3BkZi5weVwiKSxcbiAgICAgICAgZmlsZS5maWxlcGF0aFxuICAgICAgXSk7XG4gICAgICBjb25zdCBkZXRlY3RQcm9jZXNzID0gc3Bhd24oXCJweXRob24zXCIsIFtcbiAgICAgICAgcGF0aC5yZXNvbHZlKHByb2Nlc3MuY3dkKCksIFwiLi4vYmFja2VuZC9zY3JpcHRzL2RldGVjdF90YWJsZXNfaW5fcGRmLnB5XCIpLFxuICAgICAgICBmaWxlLmZpbGVwYXRoXG4gICAgICBdKTtcblxuICAgICAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBkZXRlY3RQcm9jZXNzLm9uKFwiY2xvc2VcIiwgKGNvZGUpID0+IHtcbiAgICAgICAgICBpZiAoY29kZSAhPT0gMCkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihcIuKdjCBUYWJsZSBkZXRlY3Rpb24gZmFpbGVkIHdpdGggY29kZVwiLCBjb2RlKTtcbiAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoXCJUYWJsZSBkZXRlY3Rpb24gZmFpbGVkXCIpKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCLinIUgVGFibGUgZGV0ZWN0aW9uIGZpbmlzaGVkIHN1Y2Nlc3NmdWxseVwiKTtcbiAgICAgICAgICAgIHJlc29sdmUobnVsbCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCBjb252ZXJ0UHJvY2VzcyA9IHNwYXduKFwicHl0aG9uM1wiLCBbXG4gICAgICAgIHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCBcIi4uL2JhY2tlbmQvc2NyaXB0cy9jb252ZXJ0X21zX3RvX2ltYWdlcy5weVwiKSxcbiAgICAgICAgZmlsZS5maWxlcGF0aCxcbiAgICAgICAgaW1hZ2VEaXJcbiAgICAgIF0pO1xuXG4gICAgICBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIGNvbnZlcnRQcm9jZXNzLm9uKFwiY2xvc2VcIiwgKGNvZGUpID0+IHtcbiAgICAgICAgICBpZiAoY29kZSAhPT0gMCkgcmVqZWN0KG5ldyBFcnJvcihcIkltYWdlIGNvbnZlcnNpb24gZmFpbGVkXCIpKTtcbiAgICAgICAgICBlbHNlIHJlc29sdmUobnVsbCk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG5cbiAgICAgIC8vIFJlYWQgYWxsIGltYWdlcyBpbiBpbWFnZURpciBzb3J0ZWQgYnkgcGFnZSBudW1iZXJcbiAgICAgIGNvbnN0IGltYWdlRmlsZXMgPSBmcy5yZWFkZGlyU3luYyhpbWFnZURpcilcbiAgICAgICAgLmZpbHRlcihmID0+IC9cXC4ocG5nfGpwZT9nfGJtcHx0aWZmP3x3ZWJwKSQvaS50ZXN0KGYpKVxuICAgICAgICAuc29ydCgoYSwgYikgPT4ge1xuICAgICAgICAgIGNvbnN0IG51bUEgPSBwYXJzZUludChhLm1hdGNoKC9cXGQrLyk/LlswXSB8fCBcIjBcIiwgMTApO1xuICAgICAgICAgIGNvbnN0IG51bUIgPSBwYXJzZUludChiLm1hdGNoKC9cXGQrLyk/LlswXSB8fCBcIjBcIiwgMTApO1xuICAgICAgICAgIHJldHVybiBudW1BIC0gbnVtQjtcbiAgICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHBhZ2VzV2l0aFRhYmxlc1BhdGggPSBwYXRoLnJlc29sdmUocHJvY2Vzcy5jd2QoKSwgXCJ0bXAvcGFnZXNfd2l0aF90YWJsZXMuanNvblwiKTtcbiAgICAgIGxldCBwYWdlc1N0YXR1czogeyBwYWdlOiBudW1iZXIsIGhhc190YWJsZTogYm9vbGVhbiwgaGFzX2hlYWRlcjogYm9vbGVhbiB9W10gPSBbXTtcbiAgICAgIGlmIChmcy5leGlzdHNTeW5jKHBhZ2VzV2l0aFRhYmxlc1BhdGgpKSB7XG4gICAgICAgIGNvbnN0IGRhdGEgPSBmcy5yZWFkRmlsZVN5bmMocGFnZXNXaXRoVGFibGVzUGF0aCwgXCJ1dGY4XCIpO1xuICAgICAgICBjb25zdCBwYXJzZWQgPSBKU09OLnBhcnNlKGRhdGEpO1xuICAgICAgICBwYWdlc1N0YXR1cyA9IHBhcnNlZC5wYWdlcyB8fCBbXTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnNvbGUud2FybihcIuKaoO+4jyBwYWdlc193aXRoX3RhYmxlcy5qc29uIG5vdCBmb3VuZC4gRGVmYXVsdGluZyB0byBwcm9jZXNzIGFsbCBwYWdlcy5cIik7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IG1hcmtzOiBhbnlbXSA9IFtdO1xuICAgICAgbGV0IG5vdGVCdWZmZXIgPSBcIlwiO1xuICAgICAgbGV0IGxhc3RNYXJrczogYW55W10gPSBbXTtcbiAgICAgIC8vIEltYWdlIGhhc2ggY2FjaGU6IFNldCBvZiBoYXNoZXMgc2VlbiBzbyBmYXJcbiAgICAgIGNvbnN0IHNlZW5IYXNoZXMgPSBuZXcgU2V0PHN0cmluZz4oKTtcbiAgICAgIC8vIEZvciByZXVzZTogbGFzdCByZXN1bHQgZnJvbSBwcmV2aW91cyBpbWFnZVxuICAgICAgbGV0IGxhc3RSZXN1bHQ6IGFueSA9IG51bGw7XG4gICAgICBsZXQgc2VlbkZpcnN0SGVhZGVyID0gZmFsc2U7XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW1hZ2VGaWxlcy5sZW5ndGg7ICsraSkge1xuICAgICAgICAgIGNvbnN0IHBhZ2VJbmRleCA9IGkgKyAxO1xuICAgICAgICAgIGNvbnN0IHBhZ2VTdGF0dXMgPSBwYWdlc1N0YXR1cy5maW5kKHAgPT4gcC5wYWdlID09PSBwYWdlSW5kZXgpO1xuICAgICAgICAgIGlmICghcGFnZVN0YXR1cyB8fCAhcGFnZVN0YXR1cy5oYXNfdGFibGUpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGDim5QgU2tpcHBpbmcgUGFnZSAke3BhZ2VJbmRleH0gKG5vIHRhYmxlKWApO1xuICAgICAgICAgICAgbGFzdFJlc3VsdCA9IG51bGw7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25zdCBpbWdGaWxlID0gaW1hZ2VGaWxlc1tpXTtcbiAgICAgICAgICBjb25zdCBpbWdQYXRoID0gcGF0aC5yZXNvbHZlKGltYWdlRGlyLCBpbWdGaWxlKTtcblxuICAgICAgICAgIC8vIENvbXB1dGUgaGFzaCBmb3IgdGhlIGltYWdlXG4gICAgICAgICAgY29uc3QgaW1nQnVmZmVyID0gZnMucmVhZEZpbGVTeW5jKGltZ1BhdGgpO1xuICAgICAgICAgIGNvbnN0IGltZ0hhc2ggPSBjcnlwdG8uY3JlYXRlSGFzaChcInNoYTI1NlwiKS51cGRhdGUoaW1nQnVmZmVyKS5kaWdlc3QoXCJoZXhcIik7XG5cbiAgICAgICAgICBjb25zb2xlLmxvZyhg8J+ThCBQYWdlICR7cGFnZUluZGV4fTogaGFzaCA9ICR7aW1nSGFzaH1gKTtcblxuICAgICAgICAgIGxldCBqc29uT3V0cHV0OiBhbnkgPSBudWxsO1xuICAgICAgICAgIGlmIChzZWVuSGFzaGVzLmhhcyhpbWdIYXNoKSkge1xuICAgICAgICAgICAgLy8gUmV1c2UgbGFzdCByZXN1bHQgaWYgaGFzaCBzZWVuIGJlZm9yZVxuICAgICAgICAgICAgY29uc29sZS5sb2coYPCflIEgUGFnZSAke3BhZ2VJbmRleH06IHNraXBwZWQgZHVlIHRvIGhhc2ggbWF0Y2hgKTtcbiAgICAgICAgICAgIGpzb25PdXRwdXQgPSBsYXN0UmVzdWx0O1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzZWVuSGFzaGVzLmFkZChpbWdIYXNoKTtcblxuICAgICAgICAgICAgaWYgKCFwYWdlU3RhdHVzLmhhc19oZWFkZXIgJiYgc2VlbkZpcnN0SGVhZGVyKSB7XG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKGDwn5OdIFBhZ2UgJHtwYWdlSW5kZXh9OiB0cmVhdGVkIGFzIE5vdGVzICh0YWJsZSB3L28gaGVhZGVyLCBhZnRlciBzY29yaW5nIGJlZ2lucylgKTtcbiAgICAgICAgICAgICAgY29uc3Qgb2NyVGV4dCA9IGF3YWl0IHRlc3NlcmFjdC5yZWNvZ25pemUoaW1nUGF0aCk7XG4gICAgICAgICAgICAgIG5vdGVCdWZmZXIgKz0gKG5vdGVCdWZmZXIgPyBcIlxcblwiIDogXCJcIikgKyBvY3JUZXh0O1xuICAgICAgICAgICAgICBsYXN0UmVzdWx0ID0gbnVsbDtcbiAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghcGFnZVN0YXR1cy5oYXNfaGVhZGVyICYmICFzZWVuRmlyc3RIZWFkZXIpIHtcbiAgICAgICAgICAgICAgY29uc29sZS5sb2coYPCfk4QgUGFnZSAke3BhZ2VJbmRleH06IHNraXBwZWQgKHRhYmxlIHcvbyBoZWFkZXIsIGJlZm9yZSBzY29yaW5nKWApO1xuICAgICAgICAgICAgICBsYXN0UmVzdWx0ID0gbnVsbDtcbiAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHNlZW5GaXJzdEhlYWRlciA9IHRydWU7XG5cbiAgICAgICAgICAgIC8vIOKchSDmraTml7bku4XlvZMgaGFzSGVhZGVyID09PSB0cnVlIOaJjeS8muiwg+eUqCBHUFRcbiAgICAgICAgICAgIGlmIChNT0NLX01PREUpIHtcbiAgICAgICAgICAgICAgLy8gTG9hZCBtb2NrL3BhZ2VfeC5qc29uICh4ID0gaSsxKVxuICAgICAgICAgICAgICBjb25zdCBtb2NrUGF0aCA9IHBhdGgucmVzb2x2ZShwcm9jZXNzLmN3ZCgpLCBgbW9jay9wYWdlXyR7cGFnZUluZGV4fS5qc29uYCk7XG4gICAgICAgICAgICAgIGlmICghZnMuZXhpc3RzU3luYyhtb2NrUGF0aCkpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE1vY2sgZmlsZSBub3QgZm91bmQ6ICR7bW9ja1BhdGh9YCk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgY29uc3QgbW9ja0RhdGEgPSBmcy5yZWFkRmlsZVN5bmMobW9ja1BhdGgsIFwidXRmOFwiKTtcbiAgICAgICAgICAgICAganNvbk91dHB1dCA9IEpTT04ucGFyc2UobW9ja0RhdGEpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgY29uc29sZS5sb2coYPCfk6ggU2VuZGluZyBpbWFnZSB0byBHUFQgdmlhIHBhcnNlX21hcmtzY2hlbWUucHk6ICR7aW1nRmlsZX1gKTtcbiAgICAgICAgICAgICAgY29uc29sZS5sb2coXCLwn6egIFNwYXduaW5nIHBhcnNlX21hcmtzY2hlbWUucHkgZm9yXCIsIGltZ0ZpbGUpO1xuICAgICAgICAgICAgICAvLyBDYWxsIFB5dGhvbiBzY3JpcHQgYXMgYmVmb3JlXG4gICAgICAgICAgICAgIGNvbnN0IHBhcnNlUHJvY2VzcyA9IHNwYXduKFwicHl0aG9uM1wiLCBbXG4gICAgICAgICAgICAgICAgcGF0aC5yZXNvbHZlKHByb2Nlc3MuY3dkKCksIFwiLi4vYmFja2VuZC9zY3JpcHRzL3BhcnNlX21hcmtzY2hlbWUucHlcIiksXG4gICAgICAgICAgICAgICAgaW1nUGF0aCxcbiAgICAgICAgICAgICAgXSk7XG5cbiAgICAgICAgICAgICAgbGV0IHN0ZG91dERhdGEgPSBcIlwiO1xuICAgICAgICAgICAgICBsZXQgc3RkZXJyRGF0YSA9IFwiXCI7XG5cbiAgICAgICAgICAgICAgYXdhaXQgbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgICAgIHBhcnNlUHJvY2Vzcy5zdGRvdXQub24oXCJkYXRhXCIsIChkYXRhKSA9PiB7XG4gICAgICAgICAgICAgICAgICBzdGRvdXREYXRhICs9IGRhdGEudG9TdHJpbmcoKTtcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIHBhcnNlUHJvY2Vzcy5zdGRlcnIub24oXCJkYXRhXCIsIChkYXRhKSA9PiB7XG4gICAgICAgICAgICAgICAgICBzdGRlcnJEYXRhICs9IGRhdGEudG9TdHJpbmcoKTtcbiAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGDwn5CNIHN0ZGVycjogJHtkYXRhLnRvU3RyaW5nKCl9YCk7XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICBwYXJzZVByb2Nlc3Mub24oXCJjbG9zZVwiLCAoY29kZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYOKchSBQeXRob24gZXhpdGVkIHdpdGggY29kZSAke2NvZGV9YCk7XG4gICAgICAgICAgICAgICAgICBpZiAoY29kZSAhPT0gMCkge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QobmV3IEVycm9yKGBwYXJzZV9wYWdlLnB5IGZhaWxlZCBvbiAke2ltZ0ZpbGV9OiAke3N0ZGVyckRhdGF9YCkpO1xuICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhg8J+TpCBSYXcgSlNPTiBmcm9tIFB5dGhvbiBmb3IgcGFnZSAke3BhZ2VJbmRleH06ICR7c3Rkb3V0RGF0YS5zbGljZSgwLCAyMDApfS4uLmApO1xuICAgICAgICAgICAgICAgICAgICAgIGpzb25PdXRwdXQgPSBKU09OLnBhcnNlKHN0ZG91dERhdGEpO1xuICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyOiB1bmtub3duKSB7XG4gICAgICAgICAgICAgICAgICAgICAgY29uc3QgZXJyb3IgPSBlcnIgYXMgRXJyb3I7XG4gICAgICAgICAgICAgICAgICAgICAgcmVzcG9uZGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLmpzb24oeyBlcnJvcjogXCJGYWlsZWQgdG8gcGFyc2UgcGFnZXMuXCIsIGRldGFpbDogZXJyb3IubWVzc2FnZSB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGxhc3RSZXN1bHQgPSBqc29uT3V0cHV0O1xuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIE5vdyBwcm9jZXNzIGpzb25PdXRwdXQgYXMgYmVmb3JlXG4gICAgICAgICAgaWYgKCFqc29uT3V0cHV0IHx8ICFqc29uT3V0cHV0LmhlYWRlcikge1xuICAgICAgICAgICAgLy8gTm8gaGVhZGVyIG1lYW5zIHRoaXMgcGFnZSBpcyBleHBsYW5hdGlvbiBjb250ZW50XG4gICAgICAgICAgICBpZiAoanNvbk91dHB1dD8uZXhwbGFuYXRpb24pIHtcbiAgICAgICAgICAgICAgbm90ZUJ1ZmZlciArPSAobm90ZUJ1ZmZlciA/IFwiXFxuXCIgOiBcIlwiKSArIGpzb25PdXRwdXQuZXhwbGFuYXRpb247XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBTa2lwIGFkZGluZyBtYXJrcyBmcm9tIHRoaXMgcGFnZVxuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGpzb25PdXRwdXQubWFya3MpICYmIGpzb25PdXRwdXQubWFya3MubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgLy8g5ouG5YiGIG5vdGVzIOaMieivhOWIhueCueagh+ivhu+8jOWQiOW5tuWIsCBtYXJrc1xuICAgICAgICAgICAgaWYgKG5vdGVCdWZmZXIpIHtcbiAgICAgICAgICAgICAgY29uc3Qgbm90ZUxpbmVzID0gbm90ZUJ1ZmZlci5zcGxpdCgvXFxuLykubWFwKGxpbmUgPT4gbGluZS50cmltKCkpLmZpbHRlcihCb29sZWFuKTtcbiAgICAgICAgICAgICAgY29uc3Qgbm90ZUNodW5rczogc3RyaW5nW10gPSBbXTtcblxuICAgICAgICAgICAgICAvLyDnu4Too4Xmr4/kuKror4TliIbngrnmrrXokL3vvIjmlK/mjIHlpJrooYzlkIjlubbvvIlcbiAgICAgICAgICAgICAgZm9yIChjb25zdCBsaW5lIG9mIG5vdGVMaW5lcykge1xuICAgICAgICAgICAgICAgIGNvbnN0IG1hcmtTdGFydCA9IC9eKFxcKD9bYS16XStcXCk/XFwoP1thLXpdK1xcKT9cXHMqKT8obTF8YTFcXCo/fGIxKGZ0KT98ZD9tXFxkPylbOu+8ml0vaTtcbiAgICAgICAgICAgICAgICBpZiAobm90ZUNodW5rcy5sZW5ndGggPT09IDAgfHwgbWFya1N0YXJ0LnRlc3QobGluZSkpIHtcbiAgICAgICAgICAgICAgICAgIG5vdGVDaHVua3MucHVzaChsaW5lKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgbm90ZUNodW5rc1tub3RlQ2h1bmtzLmxlbmd0aCAtIDFdICs9IFwiIFwiICsgbGluZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAvLyDlu7rnq4vor4TliIbngrnmn6Xmib7ntKLlvJVcbiAgICAgICAgICAgICAgY29uc3QgbWFya0luZGV4ID0gbmV3IE1hcDxzdHJpbmcsIGFueT4oKTtcbiAgICAgICAgICAgICAgZm9yIChjb25zdCBtYXJrIG9mIGpzb25PdXRwdXQubWFya3MpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBtYXJrS2V5ID0gKG1hcmsubGFiZWwgKyAobWFyay5tYXJrX2NvZGUgfHwgXCJcIikpLnRvTG93ZXJDYXNlKCkucmVwbGFjZSgvW1xccygpXS9nLCBcIlwiKTtcbiAgICAgICAgICAgICAgICBtYXJrSW5kZXguc2V0KG1hcmtLZXksIG1hcmspO1xuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgLy8g5oyJ5qCH6K+G5p+l5om+5bm26LWL5YC8XG4gICAgICAgICAgICAgIGZvciAoY29uc3QgY2h1bmsgb2Ygbm90ZUNodW5rcykge1xuICAgICAgICAgICAgICAgIGNvbnN0IG1hdGNoID0gY2h1bmsubWF0Y2goL14oXFwoP1thLXpdK1xcKT9cXCg/W2Etel0rXFwpP1xccyopPyhtMXxhMVxcKj98YjEoZnQpP3xkP21cXGQ/KVs677yaXS9pKTtcbiAgICAgICAgICAgICAgICBpZiAoIW1hdGNoKSBjb250aW51ZTtcbiAgICAgICAgICAgICAgICBjb25zdCBsYWJlbFJhdyA9IChtYXRjaFsxXSB8fCBcIlwiKS50cmltKCk7XG4gICAgICAgICAgICAgICAgY29uc3QgbWFya0NvZGVSYXcgPSAobWF0Y2hbMl0gfHwgXCJcIikudG9VcHBlckNhc2UoKTtcbiAgICAgICAgICAgICAgICBjb25zdCBsYWJlbCA9IGxhYmVsUmF3LnJlcGxhY2UoL1xccysvZywgXCJcIik7XG4gICAgICAgICAgICAgICAgY29uc3QgbWFya0tleSA9IChsYWJlbCArIG1hcmtDb2RlUmF3KS50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoL1tcXHMoKV0vZywgXCJcIik7XG4gICAgICAgICAgICAgICAgY29uc3QgbWFyayA9IG1hcmtJbmRleC5nZXQobWFya0tleSk7XG4gICAgICAgICAgICAgICAgaWYgKG1hcmspIHtcbiAgICAgICAgICAgICAgICAgIGlmICghbWFyay5leHBsYW5hdGlvbikgbWFyay5leHBsYW5hdGlvbiA9IFwiXCI7XG4gICAgICAgICAgICAgICAgICBtYXJrLmV4cGxhbmF0aW9uICs9IChtYXJrLmV4cGxhbmF0aW9uID8gXCJcXG5cIiA6IFwiXCIpICsgY2h1bms7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIG5vdGVCdWZmZXIgPSBcIlwiO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbWFya3MucHVzaCguLi5qc29uT3V0cHV0Lm1hcmtzKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGDinIUgUGFnZSAke3BhZ2VJbmRleH06ICR7anNvbk91dHB1dC5tYXJrcy5sZW5ndGh9IG1hcmtzIGFkZGVkYCk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhg8J+TrCBSZWNlaXZlZCAke2pzb25PdXRwdXQubWFya3MubGVuZ3RofSBtYXJrcyBmcm9tIEdQVCBmb3IgcGFnZSAke3BhZ2VJbmRleH1gKTtcbiAgICAgICAgICAgIGxhc3RNYXJrcyA9IGpzb25PdXRwdXQubWFya3M7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gRW5zdXJlIGVhY2ggbWFyayBoYXMgYW4gJ2V4cGxhbmF0aW9uJyBwcm9wZXJ0eVxuICAgICAgICBmb3IgKGNvbnN0IG1hcmsgb2YgbWFya3MpIHtcbiAgICAgICAgICBpZiAoIShcImV4cGxhbmF0aW9uXCIgaW4gbWFyaykpIHtcbiAgICAgICAgICAgIG1hcmsuZXhwbGFuYXRpb24gPSBcIlwiO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICAvLyBXcml0ZSBtYXJrcyB0byB0bXAvb3V0cHV0X21hcmtzLmpzb24gYmVmb3JlIHJldHVybmluZ1xuICAgICAgICBjb25zdCBvdXRwdXRQYXRoID0gcGF0aC5yZXNvbHZlKHByb2Nlc3MuY3dkKCksIFwidG1wL291dHB1dF9tYXJrcy5qc29uXCIpO1xuICAgICAgICBmcy53cml0ZUZpbGVTeW5jKG91dHB1dFBhdGgsIEpTT04uc3RyaW5naWZ5KHsgbWFya3MgfSwgbnVsbCwgMiksIFwidXRmOFwiKTtcbiAgICAgICAgY29uc29sZS5sb2coYPCfkr4gRmluYWwgb3V0cHV0IHdyaXR0ZW4gdG8gJHtvdXRwdXRQYXRofWApO1xuICAgICAgICByZXNwb25kZWQgPSB0cnVlO1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cygyMDApLmpzb24oeyBtYXJrcyB9KTtcbiAgICAgIH0gY2F0Y2ggKGVycjogdW5rbm93bikge1xuICAgICAgICBjb25zdCBlcnJvciA9IGVyciBhcyBFcnJvcjtcbiAgICAgICAgcmVzcG9uZGVkID0gdHJ1ZTtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgZXJyb3I6IFwiRmFpbGVkIHRvIHBhcnNlIHBhZ2VzLlwiLCBkZXRhaWw6IGVycm9yLm1lc3NhZ2UgfSk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZTogYW55KSB7XG4gICAgICByZXNwb25kZWQgPSB0cnVlO1xuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgZXJyb3I6IFwiRmFpbGVkIHRvIHByb2Nlc3MgUERGLlwiLCBkZXRhaWw6IGU/Lm1lc3NhZ2UgfSk7XG4gICAgfVxuICB9KTtcbn1cbiJdLCJuYW1lcyI6WyJJbmNvbWluZ0Zvcm0iLCJmcyIsInBhdGgiLCJzcGF3biIsImNyeXB0byIsInRlc3NlcmFjdCIsIk1PQ0tfTU9ERSIsImNvbmZpZyIsImFwaSIsImJvZHlQYXJzZXIiLCJoYW5kbGVyIiwicmVxIiwicmVzIiwicmVzcG9uZGVkIiwibWV0aG9kIiwic2V0SGVhZGVyIiwic3RhdHVzIiwianNvbiIsImVycm9yIiwiZm9ybSIsImtlZXBFeHRlbnNpb25zIiwicGFyc2UiLCJlcnIiLCJmaWVsZHMiLCJmaWxlcyIsImNvbnNvbGUiLCJsb2ciLCJmaWxlIiwicGRmIiwiQXJyYXkiLCJpc0FycmF5IiwiZmlsZXBhdGgiLCJpbWFnZURpciIsInJlc29sdmUiLCJwcm9jZXNzIiwiY3dkIiwibWtkaXJTeW5jIiwicmVjdXJzaXZlIiwiZGV0ZWN0UHJvY2VzcyIsIlByb21pc2UiLCJyZWplY3QiLCJvbiIsImNvZGUiLCJFcnJvciIsImNvbnZlcnRQcm9jZXNzIiwiaW1hZ2VGaWxlcyIsInJlYWRkaXJTeW5jIiwiZmlsdGVyIiwiZiIsInRlc3QiLCJzb3J0IiwiYSIsImIiLCJudW1BIiwicGFyc2VJbnQiLCJtYXRjaCIsIm51bUIiLCJwYWdlc1dpdGhUYWJsZXNQYXRoIiwicGFnZXNTdGF0dXMiLCJleGlzdHNTeW5jIiwiZGF0YSIsInJlYWRGaWxlU3luYyIsInBhcnNlZCIsIkpTT04iLCJwYWdlcyIsIndhcm4iLCJtYXJrcyIsIm5vdGVCdWZmZXIiLCJsYXN0TWFya3MiLCJzZWVuSGFzaGVzIiwiU2V0IiwibGFzdFJlc3VsdCIsInNlZW5GaXJzdEhlYWRlciIsImkiLCJsZW5ndGgiLCJwYWdlSW5kZXgiLCJwYWdlU3RhdHVzIiwiZmluZCIsInAiLCJwYWdlIiwiaGFzX3RhYmxlIiwiaW1nRmlsZSIsImltZ1BhdGgiLCJpbWdCdWZmZXIiLCJpbWdIYXNoIiwiY3JlYXRlSGFzaCIsInVwZGF0ZSIsImRpZ2VzdCIsImpzb25PdXRwdXQiLCJoYXMiLCJhZGQiLCJoYXNfaGVhZGVyIiwib2NyVGV4dCIsInJlY29nbml6ZSIsIm1vY2tQYXRoIiwibW9ja0RhdGEiLCJwYXJzZVByb2Nlc3MiLCJzdGRvdXREYXRhIiwic3RkZXJyRGF0YSIsInN0ZG91dCIsInRvU3RyaW5nIiwic3RkZXJyIiwic2xpY2UiLCJkZXRhaWwiLCJtZXNzYWdlIiwiaGVhZGVyIiwiZXhwbGFuYXRpb24iLCJub3RlTGluZXMiLCJzcGxpdCIsIm1hcCIsImxpbmUiLCJ0cmltIiwiQm9vbGVhbiIsIm5vdGVDaHVua3MiLCJtYXJrU3RhcnQiLCJwdXNoIiwibWFya0luZGV4IiwiTWFwIiwibWFyayIsIm1hcmtLZXkiLCJsYWJlbCIsIm1hcmtfY29kZSIsInRvTG93ZXJDYXNlIiwicmVwbGFjZSIsInNldCIsImNodW5rIiwibGFiZWxSYXciLCJtYXJrQ29kZVJhdyIsInRvVXBwZXJDYXNlIiwiZ2V0Iiwib3V0cHV0UGF0aCIsIndyaXRlRmlsZVN5bmMiLCJzdHJpbmdpZnkiLCJlIl0sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(api)/./src/pages/api/upload-parse-ms.ts\n");

/***/ })

};
;

// load runtime
var __webpack_require__ = require("../../webpack-api-runtime.js");
__webpack_require__.C(exports);
var __webpack_exec__ = (moduleId) => (__webpack_require__(__webpack_require__.s = moduleId))
var __webpack_exports__ = __webpack_require__.X(0, ["vendor-chunks/next"], () => (__webpack_exec__("(api)/./node_modules/next/dist/build/webpack/loaders/next-route-loader/index.js?kind=PAGES_API&page=%2Fapi%2Fupload-parse-ms&preferredRegion=&absolutePagePath=.%2Fsrc%2Fpages%2Fapi%2Fupload-parse-ms.ts&middlewareConfigBase64=e30%3D!")));
module.exports = __webpack_exports__;

})();